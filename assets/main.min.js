/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */

var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function r(e,t){var r,o,n,a,i,l,s,c,d,p,u,m,h=t&&t.split("/"),f=y.map,g=f&&f["*"]||{};if(e){for(e=e.split("/"),i=e.length-1,y.nodeIdCompat&&x.test(e[i])&&(e[i]=e[i].replace(x,"")),"."===e[0].charAt(0)&&h&&(m=h.slice(0,h.length-1),e=m.concat(e)),d=0;d<e.length;d++)if(u=e[d],"."===u)e.splice(d,1),d-=1;else if(".."===u){if(0===d||1===d&&".."===e[2]||".."===e[d-1])continue;d>0&&(e.splice(d-1,2),d-=2)}e=e.join("/")}if((h||g)&&f){for(r=e.split("/"),d=r.length;d>0;d-=1){if(o=r.slice(0,d).join("/"),h)for(p=h.length;p>0;p-=1)if(n=f[h.slice(0,p).join("/")],n&&(n=n[o])){a=n,l=d;break}if(a)break;!s&&g&&g[o]&&(s=g[o],c=d)}!a&&s&&(a=s,l=c),a&&(r.splice(0,l,a),e=r.join("/"))}return e}function o(t,r){return function(){var o=w.call(arguments,0);return"string"!=typeof o[0]&&1===o.length&&o.push(null),p.apply(e,o.concat([t,r]))}}function n(e){return function(t){return r(t,e)}}function a(e){return function(t){h[e]=t}}function i(r){if(t(f,r)){var o=f[r];delete f[r],g[r]=!0,d.apply(e,o)}if(!t(h,r)&&!t(g,r))throw new Error("No "+r);return h[r]}function l(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function s(e){return e?l(e):[]}function c(e){return function(){return y&&y.config&&y.config[e]||{}}}var d,p,u,m,h={},f={},y={},g={},v=Object.prototype.hasOwnProperty,w=[].slice,x=/\.js$/;u=function(e,t){var o,a=l(e),s=a[0],c=t[1];return e=a[1],s&&(s=r(s,c),o=i(s)),s?e=o&&o.normalize?o.normalize(e,n(c)):r(e,c):(e=r(e,c),a=l(e),s=a[0],e=a[1],s&&(o=i(s))),{f:s?s+"!"+e:e,n:e,pr:s,p:o}},m={require:function(e){return o(e)},exports:function(e){var t=h[e];return"undefined"!=typeof t?t:h[e]={}},module:function(e){return{id:e,uri:"",exports:h[e],config:c(e)}}},d=function(r,n,l,c){var d,p,y,v,w,x,b,C=[],$=typeof l;if(c=c||r,x=s(c),"undefined"===$||"function"===$){for(n=!n.length&&l.length?["require","exports","module"]:n,w=0;w<n.length;w+=1)if(v=u(n[w],x),p=v.f,"require"===p)C[w]=m.require(r);else if("exports"===p)C[w]=m.exports(r),b=!0;else if("module"===p)d=C[w]=m.module(r);else if(t(h,p)||t(f,p)||t(g,p))C[w]=i(p);else{if(!v.p)throw new Error(r+" missing "+p);v.p.load(v.n,o(c,!0),a(p),{}),C[w]=h[p]}y=l?l.apply(h[r],C):void 0,r&&(d&&d.exports!==e&&d.exports!==h[r]?h[r]=d.exports:y===e&&b||(h[r]=y))}else r&&(h[r]=l)},requirejs=require=p=function(t,r,o,n,a){if("string"==typeof t)return m[t]?m[t](r):i(u(t,s(r)).f);if(!t.splice){if(y=t,y.deps&&p(y.deps,y.callback),!r)return;r.splice?(t=r,r=o,o=null):t=e}return r=r||function(){},"function"==typeof o&&(o=n,n=a),n?d(e,t,r,o):setTimeout(function(){d(e,t,r,o)},4),p},p.config=function(e){return p(e)},requirejs._defined=h,define=function(e,r,o){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");r.splice||(o=r,r=[]),t(h,e)||t(f,e)||(f[e]=[e,r,o])},define.amd={jQuery:!0}}(),define("../node_modules/almond/almond",function(){}),define("helpers/data",["require"],function(e){"use strict";var t=function(){var e={queryHistory:[],queryQueue:[],queryRunning:[],timestamp:0,reporterAreasSelect:[],partnerAreasSelect:[],typeCodesSelect:[{id:"C",text:"Commodities",parent:"#"},{id:"S",text:"Services",parent:"#"}],commodityCodesSelect:[],serviceCodesSelect:[],reporterAreas:{},partnerAreas:{},flowByCode:{},commodityCodes:{},countryByUnNum:{},countryByISONum:{},xFilter:{},xFilterByReporter:{},xFilterByPartner:{},xFilterByYear:{},xFilterByType:{},xFilterByCommodity:{},xFilterByFlow:{},xFilterByAmount:{},commodityName:function(t,r){try{if("C"==r){var o=e.commodityCodes.get(t).text;return o.slice(o.indexOf(" - ")+3)}if("S"==r){var o=e.serviceCodes.get(t).text;return o.slice(o.indexOf(" ")+1)}}catch(e){return DEBUG&&console.warn("There was a problem getting a commodity name for "+t+" of type "+r+": "+e),"unknown"}},numFormat:function(e,t,r){r=r?"."+r:".1";var o=d3.format("$,"+r+"f");return 0===e?"0":"number"!=typeof e||isNaN(e)?"No data":Math.abs(e)>=1e9?o(Math.round(e/1e8)/10)+" bn":Math.abs(e)>=1e6?o(Math.round(e/1e5)/10)+" m":Math.abs(e)>=1e3?o(Math.round(e/100)/10)+" th":(o=d3.format("$,f"))(e)},numFormatFull:function(e){var t=d3.format("$,");return t(e)},numOrdinal:function(e){if(isNaN(e)||e%1)return e;if(e<20&&e>10)return e+"th";var t=e.toString().slice(-1),r="";switch(t){case"1":r=e+"st";break;case"2":r=e+"nd";break;case"3":r=e+"rd";break;default:r=e+"th"}return r},setup:function(t){"comtrade.un.org"===location.host||Modernizr.cors||(e.baseQueryUrl="proxy.php?fmt=csv&max=50000&freq=A&rg=1%2C2",e.useCors=!1),"comtrade.un.org"!==location.host&&Modernizr.cors&&(e.baseQueryUrl="https://comtrade.un.org/api/get?fmt=csv&max=50000&freq=A&rg=1%2C2",e.useCors=!0),"comtrade.un.org"===location.host&&(e.baseQueryUrl="/api/get?fmt=csv&max=50000&freq=A&rg=1%2C2",e.useCors=!1);var r={dataType:"json"};$.when($.ajax("data/reporterAreas.min.json",r),$.ajax("data/partnerAreas.min.json",r),$.ajax("data/classificationHS_AG2.min.json",r),$.ajax("data/classificationEB02.topLevel.json",r),$.ajax("data/isoCodes.csv"),$.ajax("data/world-110m.json",r)).then(function(r,o,n,a,i,l){e.reporterAreasSelect=r[0].results,e.partnerAreasSelect=o[0].results,e.commodityCodesSelect=n[0].results,e.serviceCodesSelect=a[0].results,e.worldJson=l[0];var s=d3.csv.parse(i[0]);e.countryByUnNum=d3.map(s,function(e){return e.unCode}),e.reporterAreas=d3.map(r[0].results,function(e){return e.id}),e.flowByCode=d3.map([{id:"1",text:"imports"},{id:"2",text:"exports"},{id:"0",text:"balance"}],function(e){return e.id}),e.partnerAreas=d3.map(o[0].results,function(e){return e.id}),e.commodityCodes=d3.map(n[0].results,function(e){return e.id}),e.serviceCodes=d3.map(a[0].results,function(e){return e.id}),e.countryByISONum=d3.map(s,function(e){return e.isoNumerical}),e.areasByISONum=function(e){return s.filter(function(t){return+t.isoNumerical===+e})},e.lookup=function(t,r,o){try{return e[r].get(t)[o]}catch(e){return"unknown"}},e.reporterAreasSelect=e.reporterAreasSelect.filter(function(e){return"all"!==e.id}),e.partnerAreasSelect=e.partnerAreasSelect.filter(function(e){return"all"!==e.id}),e.commodityCodesSelect=e.commodityCodesSelect.filter(function(e){return"ALL"!==e.id&&"AG2"!==e.id}),e.serviceCodesSelect=e.serviceCodesSelect.filter(function(e){return"ALL"!==e.id}),t()},function(e,r,o,n){t("There was an error with one of the initial requests.")}),this.xFilter=crossfilter(),this.xFilterByReporter=this.xFilter.dimension(function(e){return+e.reporter}),this.xFilterByPartner=this.xFilter.dimension(function(e){return+e.partner}),this.xFilterByYear=this.xFilter.dimension(function(e){return+e.year}),this.xFilterByType=this.xFilter.dimension(function(e){return e.type}),this.xFilterByCommodity=this.xFilter.dimension(function(e){return e.commodity}),this.xFilterByFlow=this.xFilter.dimension(function(e){return+e.flow}),this.xFilterByAmount=this.xFilter.dimension(function(e){return+e.value})},query:function(t,r){var o=this._buildUrl(t),n=new Date;if(e.queryHistory.indexOf(o)>-1)return void r(null,!0);var a=n.getTime()-e.timestamp;return a<1100||e.queryRunning.indexOf(o)>-1?(window.setTimeout(function(){e.query(t,r)},a+100),this.queryQueue.indexOf(o)<0&&(this.queryQueue.push(o),this._fireQueryQueueUpdateEvent()),void r(null,!1)):void $.ajax({url:o,timeout:75e3,crossDomain:e.useCors,context:this,beforeSend:function(e,t){this.timestamp=n.getTime(),this.queryRunning.push(o),$("#loadingDiv #cancelRequest").on("click",function(t){e.abort(),$("#loadingDiv").fadeOut()}),$("#loadingDiv").fadeIn()},success:function(e,n,a){this._addData(e,t),this.queryHistory.push(o),r(null,!0)},error:function(t,n,a){409===t.status&&"RATE LIMIT: You must wait 1 seconds."===t.responseText.replace(/[^\x20-\x7E]+/g,"")?(DEBUG&&console.log("API 409 Error: Requeueing the request."),e.query(o,r),r(null,!1)):409===t.status&&t.responseText.replace(/[^\x20-\x7E]+/g,"").indexOf("USAGE LIMIT: Hourly usage limit of 100 actions reached.")>-1?(DEBUG&&console.log("API 409 Error: API LIMIT REACHED!"),this.queryQueue=[],this._fireQueryQueueUpdateEvent(),r("Your IP address has reached 100 requests to the Comtrade API within the hour. Please wait one hour and then try again.",null)):(DEBUG&&console.log("Unknown API error"),r(n+" "+a+" "+t.responseText,null))},complete:function(){var e=this.queryRunning.indexOf(o);e>-1&&this.queryRunning.splice(e,1);var t=this.queryQueue.indexOf(o);t>-1&&this.queryQueue.splice(t,1),this._fireQueryQueueUpdateEvent(),0===this.queryQueue.length&&0===this.queryRunning.length&&($("#loadingDiv").fadeOut(),$("#loadingDiv #cancelRequest").off("click"))}})},getData:function(e,t){this.xFilterByReporter.filterAll(),this.xFilterByPartner.filterAll(),this.xFilterByType.filterAll(),this.xFilterByYear.filterAll(),this.xFilterByCommodity.filterAll(),this.xFilterByFlow.filterAll(),this.xFilterByAmount.filterAll(),"undefined"!=typeof e.reporter&&this.xFilterByReporter.filter(+e.reporter),"undefined"!=typeof e.partner&&"all"===e.partner&&this.xFilterByPartner.filter(function(e){return 0!==+e}),"undefined"!=typeof e.partner&&"all"!==e.partner&&this.xFilterByPartner.filter(+e.partner),"undefined"!=typeof e.year&&"all"!==e.year&&this.xFilterByYear.filter(+e.year),"undefined"!=typeof e.type&&this.xFilterByType.filter(e.type),"undefined"!=typeof e.commodity&&"AG2"!==e.commodity&&"TOTAL"!==e.commodity&&this.xFilterByCommodity.filter(e.commodity),"undefined"!=typeof e.commodity&&"AG2"===e.commodity&&this.xFilterByCommodity.filter(function(e){return"TOTAL"!==e&&200!==+e}),"undefined"!=typeof e.commodity&&"TOTAL"!==e.commodity||this.xFilterByCommodity.filter(function(e){return"TOTAL"===e||200==+e}),"undefined"!=typeof e.flow&&0!==+e.flow&&this.xFilterByFlow.filter(e.flow),t||(t=1/0);var r=this.xFilterByAmount.top(t);return r},combineData:function(e){var t=[],r=d3.map(),o=0,n=0,a={};return e=e.filter(function(e){return 0!==+e.partner||(a.reporter=e.reporter,a.partner=e.partner,a.type=e.type,a.commodity=e.commodity,a.year=e.year,1===e.flow&&(o=e.value,a.importVal=e.value),2===e.flow&&(n=e.value,a.exportVal=e.value),!1)}),a.bilateralVal=a.importVal+a.exportVal,a.balanceVal=a.exportVal-a.importVal,e.forEach(function(e){var t=["importVal","exportVal"][+e.flow-1],o=$.extend({},e);if(o.importVal=null,o.exportVal=null,o[t]=o.value,delete o.value,r.has(o.partner)){var n=r.get(o.partner);n[t]=o[t],r.set(n.partner,n)}else r.set(o.partner,o)}),t=r.values(),t=t.map(function(e){return e.importVal&&e.exportVal&&(e.bilateralVal=e.exportVal+e.importVal,e.balanceVal=e.exportVal-e.importVal),e.importVal&&0!==o&&(e.importPc=e.importVal/o*100),e.exportVal&&0!==n&&(e.exportPc=e.exportVal/n*100),e}),t.sort(function(e,t){return+(t.importVal>e.importVal)||+(t.importVal===e.importVal)-1}),t.forEach(function(e,r){e.importVal&&(t[r].importRank=r+1)}),t.sort(function(e,t){return+(t.exportVal>e.exportVal)||+(t.exportVal===e.exportVal)-1}),t.forEach(function(e,r){e.exportVal&&(t[r].exportRank=r+1)}),t.push(a),t},_buildUrl:function(t){var r=e.baseQueryUrl;return r+="undefined"!=typeof t.reporter?"&r="+t.reporter:"&r=0",r+="undefined"!=typeof t.partner?"&p="+t.partner:"&p=all",r+="undefined"!=typeof t.year&&null!==t.year?"S"==t.type&&"all"==t.year?"&ps=2011%2C2012%2C2013%2C2014%2C2015":"&ps="+t.year:"&ps=now","undefned"!=typeof t.type&&"C"==t.type&&(r+="&type=C&px=HS",r+="undefined"!=typeof t.commodity?"&cc="+t.commodity:"&cc=AG2"),"undefned"!=typeof t.type&&"S"==t.type&&(r+="&type=S&px=EB02","undefined"==typeof t.commodity||"TOTAL"==t.commodity||"ALL"==t.commodity||"AG2"==t.commodity?"TOTAL"==t.commodity?r+="&cc=200":e.serviceCodesSelect.length<20?(r+="&cc=",e.serviceCodesSelect.forEach(function(e){r+=e.id+"%2C"}),r.slice(0,-3)):r+="&cc=ALL":r+="&cc="+t.commodity),r},_addData:function(e,t){var r=d3.csv.parse(e,function(e){return{reporter:+e["Reporter Code"],partner:+e["Partner Code"],year:+e.Year,type:{H:"C",E:"S"}[e.Classification.slice(0,1)],commodity:e["Commodity Code"],flow:+e["Trade Flow Code"],value:+e["Trade Value (US$)"]}}),o=$.extend({},t);"all"==o.partner&&delete o.partner;var n=this.getData(o),a=[],i=r.filter(function(e){var t=!1;return n.forEach(function(r){e.reporter===r.reporter&&e.partner===r.partner&&e.type===r.type&&e.commodity===r.commodity&&e.flow===r.flow&&e.year===r.year&&e.value===r.value&&(t=!0,a.push(e))}),!t});this.xFilter.add(i),DEBUG&&(console.groupCollapsed("API QUERY SUCCESS from %s: r=%s p=%s cc=%s type=%s y=%s",t.initiator,t.reporter,t.partner,t.commodity,t.type,t.year),console.log("filters: %o",t),console.log("Added %d new records. Retrieved %d records. Checked %d possible matches and discarded %d duplicates. New xFilter size: %d",i.length,r.length,n.length,a.length,this.xFilter.size()),console.log("duplicates discarded: %o",a),console.groupEnd())},_fireQueryQueueUpdateEvent:function(){var e=document.createEvent("Events");e.initEvent("queryQueueUpdate",!0,!0),e.queryCount=this.queryQueue.length+this.queryRunning.length,window.dispatchEvent(e)}};return e};return t()}),define("helpers/gui",[],function(){"use strict";var e={setup:function(){fontFaceCheck.support(!1,function(e){e||$("body").addClass("no-fontsupport")}),$(window).bind("mousewheel DOMMouseScroll keydown",function(e){var t=e.keyCode||e.which;e.ctrlKey===!0&&(["wheel","mousewheel","DOMMouseScroll"].indexOf(e.type)>-1||[107,189,187,173,61].indexOf(t)>-1)&&(e.preventDefault(),DEBUG&&console.log("Sorry, zooming is disabled on this app."))}),$("#footer").show(),$("#goToCharts a, #goToMap a").tooltip(),$(".titleDropdown button").tooltip(),$("#goToCharts a, #goToMap a, #goToFooter").on("click",function(e){e.preventDefault();var t=this.hash;$("html, body").animate({scrollTop:$(t).offset().top},1e3)}),$("#facebookShareLink").on("click",function(e){e.preventDefault();var t=screen.height/2-260,r=screen.width/2-175;window.open("https://www.facebook.com/sharer/sharer.php?u="+window.location.href,"sharer","top="+t+",left="+r+",toolbar=0,status=0,width=520,height=350")}),$("#tweetLink").on("click",function(e){e.preventDefault();var t=screen.height/2-260,r=screen.width/2-175;window.open("https://twitter.com/share?text=Check%20out%20the%20International%20Trade%20in%20Goods%20DataViz&url="+window.location.href,"sharer","top="+t+",left="+r+",toolbar=0,status=0,width=520,height=350")}),window.addEventListener("queryQueueUpdate",function(e){var t=$("#loadingDiv .progress-bar");if(0===e.queryCount)return void t.attr("aria-valuenow",0).attr("aria-valuemax",0).css("width","100%");var r=Math.max(parseInt(t.attr("aria-valuemax"),10),e.queryCount),o=r-e.queryCount,n=o/r*100+"%";t.attr("aria-valuenow",o).attr("aria-valuemax",r).css("width",n)},!1),/AppleWebKit/.test(navigator.userAgent)||$('a.downloadChart[data-format="png"]').parent().addClass("disabled").attr("title","This option is not available on your browser.").attr("data-toggle","tooltip").attr("data-placement","right").tooltip(),Modernizr.blobconstructor?$("a.downloadChart").on("click",function(e){var t=$(this).attr("data-target"),r=$(this).attr("data-format"),o=$("#"+t+" .chartTitle").text(),n=$("#"+t+" .svgChart"),a=n.width(),i=n.height(),l=i,s=document.createRange(),c=document.createElement("div");s.selectNode(n[0]);var d=s.cloneContents();"choropleth"===t&&("svg"===r&&(a=1280,i=720,$(d).children("svg").removeAttr("viewBox").removeAttr("preserveAspectRatio").attr("width",a).attr("height",i)),l=645,$(d).children("svg").append('<g class="legend" transform="translate(25,25) scale(1.5)">'+$("#mapLegendSvg g.legend")[0].innerHTML+"</g>")),$(d).children("svg").attr("height",i+75).append('<text y="'+l+'"><tspan x="10" class="creditTitle">'+o+'</tspan><tspan x="10" dy="15" class="creditSource">International Trade in Goods based on UN Comtrade data</tspan><tspan x="10" dy="15" class="creditSource">Developed by the Department for Business Innovation and Skills (UK)</tspan><tspan x="10" dy="15" class="creditLink">'+document.location.href+"</tspan></text>"),c.appendChild(d.cloneNode(!0));var p=c.innerHTML;if("svg"===r){var u=new Blob([p],{type:"image/svg+xml;charset=utf8"});return void saveAs(u,t+".svg")}if("png"===r){var m=new Image;m.onload=function(){var e=document.createElement("canvas");e.width=a,e.height=i+75;var r=e.getContext("2d");r.drawImage(m,0,0);var o=document.createElement("a");o.download=t+".png";var n=e.toDataURL("image/png");o.href=n,document.body.appendChild(o),o.click()},m.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(p)))}}):$("a.downloadChart").parent().addClass("disabled").attr("title","This option is not available on your browser.").attr("data-toggle","tooltip").attr("data-placement","right").tooltip(),$("a.embedSvg").on("click",function(e){e.preventDefault(),$("#myModal #myModalLabel").html("Embed this chart"),$("#myModal .modal-body").html("<p>Copy and paste the following code:</p><pre>&lt;iframe src=&quot;"+window.location.href+"&amp;embed="+$(this).attr("data-target")+'&quot; height=&quot;500&quot; width=&quot;100%&quot;&gt;&lt;/iframe&gt;</pre><p>Preview:</p><iframe src="'+window.location.href+"&embed="+$(this).attr("data-target")+'" height="500" width="100%"></iframe>'),$("#myModal").modal("show")}),$("body").on("hidden.bs.modal",".modal",function(){$(this).removeData("bs.modal")})},showError:function(e){$("#myModalLabel").html('<span class="glyphicon glyphicon-warning-sign"></span> There was an error in querying the COMTRADE API.'),$("#myModal .modal-body").html("Charts may not display correctly, please try reloading the page or trying again later.<br /><small>Error details: "+e+"</small>"),$("#myModal").modal({show:!0})},downloadCsv:function(e,t){var r="data:text/csv;charset=utf-8,\nreporter,partner,flow,commodity,year,value\n";t.forEach(function(e,t){r+=e.reporter+","+e.partner+","+e.flow+","+e.commodity+","+e.year+","+e.value+"\n"});var o=encodeURI(r),n=document.createElement("a");n.setAttribute("href",o),n.setAttribute("download",e+".csv"),document.body.appendChild(n),n.click()}};return e}),define("helpers/controls",["./data"],function(e){"use strict";var t={$selectReporter:$("#selectReporter"),$selectPartner:$("#selectPartner"),$selectType:$("#selectType"),$selectCommodity:$("#selectCommodity"),$selectYear:$("#selectYear"),$selects:$("#selectReporter, #selectPartner, #selectType, #selectCommodity, #selectYear"),$flowButtons:$("#flowButtons"),$clearFilters:$("#clearFilters"),filters:{},setup:function(){$("#navbar").show(),this.$selectReporter.select2({placeholder:"Select a reporter",allowClear:!0,data:e.reporterAreasSelect}).on("change",t.onFilterChange),this.$selectPartner.select2({placeholder:"Select a partner",allowClear:!0,disabled:!0,data:e.partnerAreasSelect}).on("change",t.onFilterChange).select2("disable"),this.$selectType.select2({minimumResultsForSearch:1/0,data:e.typeCodesSelect}).on("change",t.onFilterChange).select2("disable"),this.$selectCommodity.select2({placeholder:"Select a commodity",allowClear:!0,data:function(){return"S"==t.filters.type?{text:"services",results:e.serviceCodesSelect}:"C"==t.filters.type?{text:"goods",results:e.commodityCodesSelect}:{text:"undefined",results:[]}}}).on("change",t.onFilterChange).select2("disable"),this.$selectYear.select2({allowClear:!1,minimumResultsForSearch:1/0,disabled:!0}).on("change",t.onFilterChange),$("#switchPartners").on("click",function(e){var r=t.getFilters();t.changeFilters({reporter:r.partner,partner:r.reporter,year:r.year,flow:r.flow})}),this.$flowButtons.on("click",function(e){$("#flowButtons button").removeClass("btn-primary").addClass("btn-default"),$(e.target).closest("button").removeClass("btn-default").addClass("btn-primary"),t.onFilterChange()}),this.$clearFilters.on("click",function(e){$("#selectReporter, #selectPartner, #selectCommodity").off("change",t.onFilterChange).val(null).trigger("change").on("change",t.onFilterChange),t.onFilterChange()}),$("#closeContextMenu").on("click",function(e){e.preventDefault(),$("#contextMenu").hide()}),$("#contextMenu .setReporter").on("click",function(e){e.preventDefault(),$(e.target.parentNode).hasClass("disabled")||t.changeFilters({reporter:$(e.target).attr("data-uncode")}),$("#contextMenu").hide()}),$("#contextMenu .setPartner").on("click",function(e){e.preventDefault(),$(e.target.parentNode).hasClass("disabled")||t.changeFilters({partner:$(e.target).attr("data-uncode")}),$("#contextMenu").hide()})},getFilters:function(){var e={};return""!==t.$selectReporter.val()&&(e.reporter=t.$selectReporter.val()),""!==t.$selectPartner.val()&&(e.partner=t.$selectPartner.val()),""!==t.$selectType.val()&&(e.type=t.$selectType.val()),""!==t.$selectCommodity.val()&&(e.commodity=t.$selectCommodity.val()),""!==t.$selectYear.val()&&(e.year=t.$selectYear.val()),""!==$("#flowButtons .btn-primary").attr("data-value")&&(e.flow=$("#flowButtons .btn-primary").attr("data-value")),e},onFilterChange:function(e){var r=t.getFilters();t.filters.reporter===r.reporter&&t.filters.partner===r.partner&&t.filters.commodity===r.commodity&&t.filters.type===r.type&&t.filters.year===r.year&&t.filters.flow===r.flow||(t.filters.type!=r.type&&(r.commodity=void 0,"S"==r.type&&(t.$selectCommodity.data("select2").opts.placeholder="Select service"),"C"==r.type&&(t.$selectCommodity.data("select2").opts.placeholder="Select commodity"),t.$selectCommodity.data("select2").setPlaceholder(),t.$selectCommodity.select2("val","")),!t.filters.partner&&r.partner&&$("html, body").animate({scrollTop:$("#charts").offset().top},2e3),t.fadeControls(r),t.showElements(r),$(".chart").trigger("refreshFilters",r),t.updateURL(r),t.filters=r)},changeFilters:function(e){(e.reporter||""!==t.$selectReporter.val())&&(e.reporter&&e.reporter!==t.$selectReporter.val()&&t.$selectReporter.val(e.reporter),e.type&&e.type!==t.$selectType.val()&&t.$selectType.val(e.type),e.commodity&&e.commodity!==t.$selectCommodity.val()&&t.$selectCommodity.val(e.commodity),e.partner&&e.partner!==t.$selectPartner.val()&&t.$selectPartner.val(e.partner),e.year&&e.year!==t.$selectYear.val()&&(t.updateYears([+t.$selectYear.val(),e.year]),t.$selectYear.val(e.year)),t.$selects.trigger("change"))},initializeFilters:function(){var e=this.decodeURL();e&&e.reporter&&e.type?this.changeFilters(e):t.changeFilters({reporter:826,year:2014,type:"C"})},decodeURL:function(){var e=window.History;try{var t={},r=e.getState();return r.hash.split("?",2)[1].split("&").forEach(function(e){e=e.replace(/%20|\+/g," ").split("="),t[decodeURIComponent(e[0])]=e[1]?decodeURIComponent(e[1]):void 0}),t.year&&(t.year=+t.year),t}catch(e){return{}}},updateURL:function(e){var t=window.History,r="?",o="";for(o in e)r+=encodeURIComponent(o),e[o]&&(r+="="+encodeURIComponent(e[o])),r+="&";r=r.slice(0,-1),t.replaceState(null,"International Trade in Goods by Country and Commodity",r)},updateYears:function(e){if(e.length>0){var r=+t.$selectYear.val();t.$selectYear.html(""),e.sort(function(e,t){return t-e}).forEach(function(e){t.$selectYear.append('<option value="'+e+'">'+e+"</option>")}),e.indexOf(r)>=0?t.$selectYear.val(+r):t.$selectYear.val(d3.max(e)).trigger("change")}},fadeControls:function(r){r.reporter?($("#selectType").select2("enable"),$("#selectCommodity").select2("enable"),$("#selectPartner").select2("enable"),$("#selectYear").select2("enable"),r.partner&&"unknown"!=e.lookup(r.partner,"reporterAreas","id")?$("#switchPartners").prop("disabled",!1):$("#switchPartners").prop("disabled",!0)):($("#selectReporter, #selectPartner, #selectCommodity").off("change",t.onFilterChange).val(null).trigger("change").on("change",t.onFilterChange),$("#selectType").select2("disable"),$("#selectCommodity").select2("disable"),$("#selectPartner").select2("disable"),$("#selectYear").select2("disable"),$("#switchPartners").prop("disabled",!0))},showElements:function(e){e.reporter?($("#goToCharts, #goToMap, #flowButtons").show(),$("#charts").slideDown(),$("#contextMenu .setPartner").removeClass("disabled")):($("#goToCharts, #goToMap, #flowButtons").hide(),$("#charts").slideUp(),$("#contextMenu .setPartner").addClass("disabled"))},showError:function(e){$("#myModalLabel").html('<span class="glyphicon glyphicon-warning-sign"></span> There was an error in querying the COMTRADE API.'),$("#myModal .modal-body").html(e),$("#myModal").modal({show:!0})}};return t}),define("helpers/charts/infoBox",["../data","../gui","../controls"],function(e,t,r){"use strict";var o=e,n=$("#infoBox"),a=$("#defaultPanel"),i=$("#hoverPanel"),l=10,s=function(){return $(document).width()>992?Math.min($("#infoBoxPlaceholder").offset().top,$(window).height()-n.height()-l+$(window).scrollTop())+"px":$("#infoBoxPlaceholder").offset().top},c=function(){return $("#infoBoxPlaceholder").width()-20+"px"},d=function(){n.css({top:s(),width:c()})},p={setup:function(){n.show().css({top:$(window).height()-n.height()-l+$(window).scrollTop(),width:c()}),$(window).scroll(d),i.slideUp(),$(window).on("resize",d),setTimeout(d,800),n.on("refreshFilters",this.refresh)},refresh:function(r,i){if(!i.reporter)return void n.slideUp();n.slideDown();var l={reporter:+i.reporter,partner:0,year:+i.year,commodity:"AG2",initiator:"infoBox",type:i.type},s={reporter:+i.reporter,year:+i.year,commodity:"TOTAL",type:i.type};i.partner&&0!==i.partner||(s.partner=0),!i.reporter||i.commodity||i.partner||(l.commodity="TOTAL",l.year="all"),i.reporter&&!i.commodity&&i.partner&&(l.partner="all",l.commodity="TOTAL",l.year=+i.year),i.reporter&&i.commodity&&i.partner&&(l.partner="all",l.commodity=i.commodity,s.commodity=i.commodity),i.reporter&&i.commodity&&!i.partner&&(l.partner="all",l.commodity=i.commodity,s.commodity=i.commodity),e.query(l,function(e,r){if(e&&t.showError(e),!e&&r){var n=o.getData(s),l=o.combineData(n),c=d3.map(l,function(e){return e.partner});p.populateBox(a,c.get(i.partner||0),i.partner)}})},populateBox:function(e,t,r){if(e.find(".subtitle").html(""),e.find(".value").html(""),e.find(".ranking").html(""),e.find("dt").show(),!t)return e.find(".subtitle").html('<p class="text-center"><strong>No data available for '+o.lookup(r,"countryByUnNum","name")+".</strong></p>"),e.find(".value, .ranking").html(""),void e.find("dt").hide();var n=o.lookup(t.reporter,"reporterAreas","text"),a=o.lookup(t.partner,"partnerAreas","text"),i="<strong>"+n+"</strong> trade in "+{S:"services",C:"goods"}[t.type]+" with <strong>"+a+"</strong> in <strong>"+t.year+"</strong><br />";if(t.commodity&&"TOTAL"!==t.commodity&&(i+="<strong>"+o.commodityName(t.commodity,t.type)+"</strong>"),e.find(".subtitle").html(i),e.find(".value.exports").html(o.numFormat(t.exportVal,null,1)),e.find(".value.imports").html(o.numFormat(t.importVal,null,1)),e.find(".value.balance").html(o.numFormat(t.balanceVal,null,1)),e.find(".value.bilateral").html(o.numFormat(t.bilateralVal,null,1)),t.partner&&0!==t.partner&&t.importRank&&t.exportRank){var l=a+" was the "+o.numOrdinal(t.exportRank)+" largest export market for "+n+" ("+t.exportPc.toFixed(1)+"% of "+n+" exports) and the "+o.numOrdinal(t.importRank)+" largest import market for "+n+" ("+t.importPc.toFixed(1)+"% of "+n+" imports)";t.commodity&&"TOTAL"!==t.commodity&&(l+=" for "+o.commodityName(t.commodity,t.type)),l+=" in "+t.year+".",e.find(".ranking").html(l)}},displayHover:function(e,t){p.populateBox(i,e,t),a.stop().slideUp(),i.stop().slideDown()},hideHover:function(){i.stop().slideUp(),a.stop().slideDown()}};return p}),define("helpers/charts/choropleth",["../data","../gui","./infoBox","../controls"],function(e,t,r,o){"use strict";var n=e,a=$("#choropleth"),i=$("#choroplethTitle .chartTitle"),l=720,s=1280,c=d3.select("#choropleth .chart").append("svg").classed("choropleth",!0).classed("svgChart",!0).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr("id","choroplethSvg").attr("viewBox","0 0 "+s+" "+l).attr("preserveAspectRatio","xMidYMid meet"),d={setup:function(t){a.show(),a.on("refreshFilters",this.refresh);var o=d3.geo.kavrayskiy7().scale(230).translate([s/2+50,l/2]).precision(.1),i=d3.geo.path().projection(o),d=function(){c.attr("width",a.width()).attr("height",a.height())};d(),d3.select(window).on("resize",d),c.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",i).attr("stroke","#054D82").attr("stroke-width","1.5px").attr("fill","none"),c.append("use").attr("class","stroke").attr("xlink:href","#sphere"),c.append("use").attr("class","fill").attr("xlink:href","#sphere");var p=topojson.feature(e.worldJson,e.worldJson.objects.countries).features;c.append("g").attr("class","countries").selectAll(".country").data(p).enter().append("path").attr("class","country").attr("d",i).attr("id",function(e){return"iso"+e.id}).on("click",function(e,t){d3.event.preventDefault(),$("#contextMenu .country").html(n.lookup(e.id,"countryByISONum","name")),$("#contextMenu .setReporter a, #contextMenu .setPartner a").attr("data-uncode",n.lookup(e.id,"countryByISONum","unCode")),$("#closeContextMenu").on("click",function(e){e.preventDefault(),r.hideHover()}),$("#contextMenu").css({display:"block",left:d3.event.pageX,top:d3.event.pageY})}),t&&t()},refresh:function(r,o){var l={reporter:+o.reporter,partner:"all",year:+o.year,initiator:"choropleth"},s={reporter:+o.reporter,partner:"all",year:+o.year,flow:+o.flow},p="";return o.reporter?(o.reporter&&!o.commodity&&(l.commodity="TOTAL",l.type=o.type,s.commodity="TOTAL",s.type=o.type,p=n.lookup(o.reporter,"countryByUnNum","name")+[" trade in "+{S:"services",G:"goods"}[o.type]+" balance "," imports of "+{S:"services",G:"goods"}[o.type]+" "," exports of "+{S:"services",G:"goods"}[o.type]+" "][o.flow]+" in "+o.year),o.reporter&&o.commodity&&(l.commodity=o.commodity,l.type=o.type,s.commodity=o.commodity,s.type=o.type,p=n.lookup(o.reporter,"countryByUnNum","name")+[" trade in "+n.commodityName(o.commodity,o.type)+" balance "," imports of "+n.commodityName(o.commodity,o.type)+" "," exports of "+n.commodityName(o.commodity,o.type)+" "][o.flow]+" in "+o.year),void e.query(l,function(e,r){if(e&&t.showError(e),!e&&r){d._redrawMap(s),i.html(p);var o=n.getData(s);a.find(".downloadData").unbind("click").on("click",function(e){e.preventDefault(),t.downloadCsv(p,o)})}})):(c.selectAll(".country").style("fill","#fff"),c.selectAll(".highlighted").classed("highlighted",!1),void i.html(""))},_redrawMap:function(e){var t,o;1===+e.flow&&(t="importRank",o="importVal"),2===+e.flow&&(t="exportRank",o="exportVal"),0===+e.flow&&(t="balanceVal",o="balanceVal");var a=n.getData({reporter:e.reporter,type:e.type,commodity:e.commodity,year:+e.year});a=n.combineData(a),a=a.filter(function(e){return e[t]&&e[o]&&0!==e.partner});var i,l,s=d3.map(a,function(e){return e.partner}),p=a.length,u=d3.scale.threshold();0===+e.flow?u.domain([0]).range([0,1]):(p>25&&(i=[4,p/4,p/2,3*p/4],l=[4,3,2,1,0]),p<=25&&p>4&&(i=[p/4,p/2,3*p/4],l=[3,2,1,0]),p<=4&&(i=[p],l=[0]),u=d3.scale.threshold().domain(i).range(l)),c.selectAll(".country").classed("highlighted",!1).on("mouseenter",function(e,t){try{var o=n.countryByISONum.get(e.id).unCode,a=s.get(o);a?r.displayHover(a):r.displayHover(!1,o),c.selectAll(".country").sort(function(t,r){return(t.id===e.id)-(r.id===e.id)})}catch(t){r.displayHover(!1),DEBUG&&console.log("No country in database by "+e.id+" isoCode.")}}).on("mouseleave",function(e,t){r.hideHover()}).transition().duration(1e3).style("fill",function(r,o){var a=n.areasByISONum(r.id),i=[],l=0;try{if(a.forEach(function(e){var t=s.get(e.unCode);t&&i.push(s.get(e.unCode))}),0===i.length)throw"No data points for "+n.lookup(r.id,"countryByUnNum","name");if(i.length>1)throw"Multiple data points for "+n.lookup(r.id,"countryByUnNum","name");if(null===i[0][t])throw"Incomplete data for "+n.lookup(r.id,"countryByUnNum","name");return l=u(i[0][t]),d.colors[e.flow][l]}catch(e){return"#818181"}});var m=d3.nest().key(function(e){return u(e[t])}).rollup(function(e){return{min:d3.min(e,function(e){return e[o]}),max:d3.max(e,function(e){return e[o]}),count:e.length}}).entries(a);d._drawLegend(m,e.flow),c.select("#iso"+n.lookup(e.reporter,"countryByUnNum","isoNumerical")).classed("highlighted",!0)},_drawLegend:function(e,t){var r=d3.select("#mapLegend svg"),o=30,a=5,i=d.colors[t].slice(0,e.length),l=["Balance","Imports","Exports"][t],s=e.reduce(function(e,t,r,o){
return e+t.values.count},0);r.attr("height",(e.length+1)*(o+a)+25).attr("width",225),r.select("g.legend").remove(),r.select("text.title").remove(),r.append("text").attr("class","title").attr("x",0).attr("y",18).style("font-weight","bold").text(l+" Legend");var c=r.append("g").attr("class","legend").attr("transform","translate(0,25)");c.append("rect").attr("class","noData").attr("x",0).attr("y",0).attr("rx",1).attr("ry",1).attr("width",8).attr("height",15).style("fill","#818181"),c.append("text").attr("class","noData").attr("x",12).attr("y",13).text("No data available"),c=c.append("g").attr("class","scale").attr("transform","translate(0,18)"),c.selectAll("rect").data(d3.range(i.length)).enter().append("rect").attr("x",0).attr("y",function(e,t){return 33*t}).attr("rx",1).attr("ry",1).attr("width",8).attr("height",30).style("fill",function(e,t){return i[t]});var p=c.selectAll("text").data(d3.range(i.length)).enter().append("text").attr("y",function(e,t){return 33*t+14});p.append("tspan").attr("class","line1").attr("x",12).text(function(r,o){if(+t>0)return n.numFormat(e[o].values.min,null,1)+" - "+n.numFormat(e[o].values.max,null,1)+" ("+e[o].values.count+" partners)"}),p.append("tspan").attr("class","line1").attr("x",12).attr("dy",15).text(function(r,o){if(0===+t)return["Deficit","Surplus"][o]+" ("+e[o].values.count+" partners)";var n="";switch(o){case 0:n=s<=4?"Not enough data to map":"Up to 25th percentile";break;case 1:n="25th to 50th percentile";break;case 2:n="50th to 75th percentile";break;case 3:n="Above 75th percentile excl. top 3";break;case 4:var a=3/s*100;n="Top 3 - above "+a.toFixed(1)+" percentile"}return n})}};return d}),define("helpers/charts/yearChart",["../data","../gui","../controls"],function(e,t,r){"use strict";var o=e,n=$("#yearChart"),a=n.children(".chart"),i=n.children(".chartTitle"),l=d3.select("#yearChart .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0),s={top:25,right:15,bottom:75,left:70},c=a.height(),d=a.width(),p=c-s.top-s.bottom,u=d-s.left-s.right,m=d3.scale.linear().range([0,u]).clamp(!0),h=d3.scale.linear().range([p,0]),f=d3.svg.axis().scale(m).orient("bottom").tickFormat(d3.format(".0f")),y=d3.svg.axis().scale(h).orient("left").ticks(6).tickFormat(o.numFormat),g=d3.svg.line().interpolate("linear"),v={setup:function(){a.on("refreshFilters",this.refresh),$(window).on("resize",this.resizeSvg),l.attr("width",d).attr("height",c),l.append("g").attr("class","x axis").attr("transform","translate("+s.left+","+(s.top+p)+")").call(f),l.append("g").attr("class","y axis").attr("transform","translate("+s.left+","+s.top+")").call(y),l.append("g").attr("class","plots").attr("transform","translate("+s.left+","+s.top+")");var e=l.append("g").attr("class","legend").attr("transform","translate("+(u+s.left-120*v.colors[0].length)+",0)").selectAll(".legendItem").data(v.colors[0]).enter().append("g").attr("class","legendItem");e.append("circle").attr("cx",function(e,t){return 120*t}).attr("cy","10").attr("r","5").style("fill",function(e){return e}),e.append("text").attr("transform",function(e,t){return"translate("+(120*t+10)+",15)"}).text(function(e,t){return["Imports","Exports"][t]}),n.slideUp(0)},refresh:function(r,a){if(!a.reporter)return void n.slideUp();var l={reporter:+a.reporter,year:"all",initiator:"yearChart",type:a.type},s={reporter:+a.reporter,year:"all",type:a.type},c="";!a.reporter||a.commodity||a.partner||(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in "+{S:"services",C:"goods"}[a.type]+" with the world",l.partner=0,l.commodity="TOTAL",s=l),a.reporter&&!a.commodity&&a.partner&&(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in "+{S:"services",C:"goods"}[a.type]+" with "+o.lookup(a.partner,"partnerAreas","text"),l.partner=a.partner,l.commodity="TOTAL",s.partner=+a.partner,s.commodity="TOTAL"),a.reporter&&a.commodity&&a.partner&&(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in "+o.commodityName(a.commodity,a.type)+" with "+o.lookup(a.partner,"partnerAreas","text"),l.partner=+a.partner,l.commodity=a.commodity,s.partner=+a.partner,s.commodity=a.commodity),a.reporter&&a.commodity&&!a.partner&&(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in "+o.commodityName(a.commodity,a.type)+" with the world",l.partner=0,l.commodity=a.commodity,s.partner=0,s.commodity=a.commodity),e.query(l,function(e,r){if(e&&t.showError(e),!e&&r){var a=o.getData(s),l=d3.min(a,function(e){return e.year});c+=" since "+l,i.html(c),n.find(".downloadData").unbind("click").on("click",function(e){e.preventDefault(),t.downloadCsv(c,a)}),n.slideDown(400,function(){v._draw(a)})}})},_draw:function(e){if(0===e.length)return l.append("text").text("No data available for this chart.").classed("nodata",!0).classed("label",!0).attr("x",u/2+s.left-75).attr("y",p/2+s.top-75),void l.selectAll(".flow").remove();l.selectAll(".nodata").remove();var t=d3.nest().key(function(e){return e.flow}).sortValues(function(e,t){return e.year-t.year}).entries(e),n=d3.extent(e,function(e){return e.year}),a=d3.range(n[0],n[1]+1),i=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return e.year+": "+o.numFormat(e.value,null,1)+" "+["imports","exports"][e.flow-1]});t.length<2&&(console.log(t),2===+t[0].key?t.unshift({key:1,values:[]}):t.push({key:2,values:[]}),console.log(t)),m.domain([n[0],n[1]+1]),h.domain([0,d3.max(e,function(e){return e.value})]),g.x(function(e){return m(e.year)}).y(function(e){return h(e.value)}),f.scale(m).tickValues(a).tickSize(6,0).tickFormat(d3.format(".0f")),y.scale(h).tickSize(6,0).tickFormat(o.numFormat),r.updateYears(a),l.select(".x.axis").transition().call(f).selectAll("g.x text").attr("transform","rotate(-65) translate(-22,-10)"),l.select(".y.axis").transition().call(y);var c=l.selectAll("line.yearHighlight").data([1]),d=$("#selectYear").val();c.enter().append("line").attr("class","yearHighlight").attr("x1","0").attr("y1",s.top).attr("x2","0").attr("y2",s.top+p).attr("stroke","#054D82").attr("stroke-dasharray","5, 5").attr("stroke-width","1"),c.transition().attr("x1",function(e){return m(+d)+s.left}).attr("x2",function(e){return m(+d)+s.left});var w=l.select(".plots"),x=w.selectAll("path.flow").data(t);x.enter().append("path").attr("class","flow").style("stroke",function(e){return v.colors[0][e.key-1]}).style("fill","none").style("stroke-width","1.5px"),x.transition().attr("d",function(e){return g(e.values)});var b=w.selectAll("g.flow").data(t);b.enter().append("g").attr("class","flow");var C=b.selectAll("circle.dot").data(function(e){return e.values});C.enter().append("circle").attr("class","dot").attr("r","3").style("fill",function(e){return v.colors[0][e.flow-1]}).style("stroke-width","0").on("mouseover",function(e){i.show(e),d3.select(this).interrupt().transition().attr("r","6")}).on("mouseout",function(e){i.hide(e),d3.select(this).interrupt().transition().attr("r","3")}).on("click",function(e){r.changeFilters({year:e.year})}),C.transition().attr("cx",function(e){return m(e.year)}).attr("cy",function(e){return h(e.value)}),C.exit().remove(),w.call(i)},resizeSvg:function(){d=a.width(),l.attr("width",d),u=d-s.left-s.right,m.range([0,u]),f.scale(m),l.select(".x.axis").transition().call(f),l.select("g.legend").attr("transform","translate("+(u+s.left-120*v.colors[0].length)+",0)"),l.selectAll("circle.dot").transition().attr("cx",function(e){return m(e.year)}),g.x(function(e){return m(e.year)}),l.selectAll("path.flow").transition().attr("d",function(e){return g(e.values)});var e=$("#selectYear").val();l.selectAll("line.yearHighlight").transition().attr("x1",function(t){return m(+e)+s.left}).attr("x2",function(t){return m(+e)+s.left})}};return v}),define("helpers/rowchart",["./data","./controls"],function(e,t){"use strict";var r=e,o={margin:{top:25,right:60,bottom:75,left:35},innerHeight:0,innerWidth:0,xScale:d3.scale.linear(),yScale:d3.scale.linear(),xAxis:d3.svg.axis().tickSize(0,0).tickFormat(""),yAxis:d3.svg.axis(),barHeight:0,setup:function(e){o.innerHeight=e.attr("height")-o.margin.top-o.margin.bottom,o.innerWidth=e.attr("width")-o.margin.left-o.margin.right,o.xScale.range([0,o.innerWidth]),o.yScale.range([0,o.innerHeight]).clamp(!0),o.xAxis.scale(o.xScale).orient("bottom").tickFormat(r.numFormat),o.yAxis.scale(o.yScale).orient("left"),e.append("g").attr("class","bars").attr("transform","translate("+o.margin.left+","+o.margin.top+")"),e.append("g").attr("class","x axis").attr("transform","translate("+o.margin.left+","+(o.innerHeight+o.margin.top)+")").call(o.xAxis),e.append("g").attr("class","y axis").attr("transform","translate("+o.margin.left+","+o.margin.top+")").call(o.yAxis)},draw:function(e,n,a,i){o.xScale.domain([0,d3.max(n,function(e){return e.value})]).nice(),o.yScale.domain([0,d3.max([10,n.length])]).clamp(!0).nice(),o.xAxis.scale(o.xScale).tickSize(6,0).tickFormat(r.numFormat),o.yAxis.scale(o.yScale).ticks(0),o.barHeight=o.yScale(1)-20,e.select("text.nodata").remove(),e.select(".x.axis").transition().call(o.xAxis).selectAll("text").attr("transform","rotate(-65) translate(-13,-10)").style("text-anchor","end"),e.select(".y.axis").transition().call(o.yAxis);var l=e.select(".bars").selectAll("g.item").data(n);l.enter().append("g").append("rect").attr("width","0").attr("height","0"),l.classed("item",!0).attr("transform",function(e,t){return"translate(0,"+o.yScale(t)+")"}),l.selectAll("g.item text").remove();var s=l.select("rect").on("click",function(e){"all"===a.partner?t.changeFilters({partner:e.partner}):t.changeFilters({commodity:e.commodity})}),c=l.append("text").classed("label",!0),d=l.append("text").classed("value",!0);s.transition().attr("x",0).attr("y",o.yScale(1)-o.barHeight-5).style("fill",i).attr("height",o.barHeight).attr("width",function(e,t){return d3.max([0,o.xScale(+e.value)])}),c.attr("x","3").attr("y",o.yScale(1)-o.barHeight-8).text(function(e){return"all"===a.partner?r.lookup(e.partner,"partnerAreas","text"):r.commodityName(e.commodity,a.type)}),d.attr("x",function(e,t){return o.xScale(+e.value)+3}).attr("y",o.yScale(1)-5).text(function(e){return r.numFormat(e.value,null,1)}),l.exit().remove(),0===l.size()&&e.append("text").text("No data available for this chart.").classed("nodata",!0).classed("label",!0).attr("x",o.innerWidth/2+o.margin.left-75).attr("y",o.innerHeight/2+o.margin.top-75)},resizeSvg:function(e,t){e.attr("width",t),o.innerWidth=e.attr("width")-o.margin.left-o.margin.right,o.xScale.range([0,o.innerWidth]),o.xAxis.scale(o.xScale),e.select(".x.axis").transition().call(o.xAxis);var r=e.selectAll("g.item");r.selectAll("rect").attr("width",function(e,t){return o.xScale(+e.value)}),r.selectAll("text.value").attr("x",function(e,t){return o.xScale(+e.value)+3})}};return o}),define("helpers/charts/topExportCommodities",["../data","../rowchart","../gui","../controls"],function(e,t,r,o){"use strict";var n=e,a=$("#topExportCommodities"),i=a.children(".chart"),l=a.children(".chartTitle"),s=i.height(),c=i.width(),d=d3.select("#topExportCommodities .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",s).attr("width",c),p=10,u={setup:function(){i.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(d,i.width())}),t.setup(d),a.slideUp(0)},refresh:function(o,i){if(!i.reporter)return void a.slideUp();var s={reporter:+i.reporter,partner:0,year:+i.year,commodity:"AG2",initiator:"topExportCommodities",type:i.type},c={reporter:+i.reporter,partner:0,year:+i.year,commodity:"AG2",type:i.type},m="";return c.flow=2,!i.reporter||i.commodity&&"TOTAL"!==i.commodity||i.partner||(m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 exports of "+{S:"services",C:"goods"}[i.type]+" to the world in "+i.year),!i.reporter||i.commodity&&"TOTAL"!==i.commodity||!i.partner||(m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 exports of "+{S:"services",C:"goods"}[i.type]+" to "+n.lookup(i.partner,"partnerAreas","text")+" in "+i.year,s.partner=+i.partner,c.partner=+i.partner),i.reporter&&i.commodity&&"TOTAL"!==i.commodity&&i.partner?(l.html(""),void a.slideUp()):i.reporter&&i.commodity&&"TOTAL"!==i.commodity&&!i.partner?(l.html(""),void a.slideUp()):(l.html(m),void e.query(s,function(e,o){if(e&&r.showError(e),!e&&o){var i=n.getData(c,p);l.html(m),a.find(".downloadData").unbind("click").on("click",function(e){e.preventDefault(),r.downloadCsv(m,i)}),a.slideDown(400,function(){t.draw(d,i,c,u.colors[0][1])})}}))}};return u}),define("helpers/charts/topExportMarkets",["../data","../rowchart","../gui","../controls"],function(e,t,r,o){"use strict";var n=e,a=$("#topExportMarkets"),i=a.children(".chart"),l=a.children(".chartTitle"),s=i.height(),c=i.width(),d=d3.select("#topExportMarkets .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",s).attr("width",c),p=10,u={setup:function(){i.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(d,i.width())}),t.setup(d),a.slideUp(0)},refresh:function(o,i){if(!i.reporter)return void a.slideUp();var s={reporter:+i.reporter,partner:"all",year:+i.year,commodity:"AG2",initiator:"topExportMarkets",type:i.type},c={reporter:+i.reporter,partner:"all",year:i.year,commodity:"AG2",type:i.type},m="";return c.flow=2,!i.reporter||i.commodity||i.partner&&0!==+i.partner||(m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 export markets for "+{S:"services",C:"goods"}[i.type]+" in "+i.year,s.commodity="TOTAL",c.commodity="TOTAL"),i.reporter&&!i.commodity&&i.partner&&0!==+i.partner?(l.html(""),void a.slideUp()):i.reporter&&i.commodity&&i.partner&&0!==+i.partner?(l.html(""),void a.slideUp()):(!i.reporter||!i.commodity||i.partner&&0!==+i.partner||(m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 export markets for "+n.commodityName(i.commodity,i.type)+" in "+i.year,s.commodity=i.commodity,c.commodity=i.commodity),void e.query(s,function(e,o){if(e&&r.showError(e),!e&&o){var i=n.getData(c,p);l.html(m),a.find(".downloadData").unbind("click").on("click",function(e){e.preventDefault(),r.downloadCsv(m,i)}),a.slideDown(400,function(){t.draw(d,i,c,u.colors[0][1])})}}))}};return u}),define("helpers/charts/topImportCommodities",["../data","../rowchart","../gui","../controls"],function(e,t,r,o){"use strict";var n=e,a=$("#topImportCommodities"),i=a.children(".chart"),l=a.children(".chartTitle"),s=i.height(),c=i.width(),d=d3.select("#topImportCommodities .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",s).attr("width",c),p=10,u={setup:function(){i.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(d,i.width())}),t.setup(d),a.slideUp(0)},refresh:function(o,i){if(!i.reporter)return void a.slideUp();var s={reporter:+i.reporter,partner:0,year:+i.year,commodity:"AG2",initiator:"topImportCommodities",type:i.type},c={reporter:+i.reporter,partner:0,year:+i.year,commodity:"AG2",type:i.type},m="";return c.flow=1,!i.reporter||i.commodity&&"TOTAL"!==i.commodity||i.partner||(m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 imports of "+{S:"services",C:"goods"}[i.type]+" from the world in "+i.year),!i.reporter||i.commodity&&"TOTAL"!==i.commodity||!i.partner||(m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 imports of "+{S:"services",C:"goods"}[i.type]+" from "+n.lookup(i.partner,"partnerAreas","text")+" in "+i.year,s.partner=+i.partner,c.partner=+i.partner),i.reporter&&i.commodity&&"TOTAL"!==i.commodity&&i.partner?(l.html(""),void a.slideUp()):i.reporter&&i.commodity&&"TOTAL"!==i.commodity&&!i.partner?(l.html(""),void a.slideUp()):void e.query(s,function(e,o){if(e&&r.showError(e),!e&&o){var i=n.getData(c,p);l.html(m),a.find(".downloadData").unbind("click").on("click",function(e){e.preventDefault(),r.downloadCsv(m,i)}),a.slideDown(400,function(){t.draw(d,i,c,u.colors[0][0])})}})}};return u}),define("helpers/charts/topImportMarkets",["../data","../rowchart","../gui","../controls"],function(e,t,r,o){"use strict";var n=e,a=$("#topImportMarkets"),i=a.children(".chart"),l=a.children(".chartTitle"),s=i.height(),c=i.width(),d=d3.select("#topImportMarkets .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",s).attr("width",c),p=10,u={setup:function(){i.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(d,i.width())}),t.setup(d),a.slideUp(0)},refresh:function(o,i){if(!i.reporter)return void a.slideUp();var s={reporter:+i.reporter,partner:"all",year:i.year,commodity:"AG2",initiator:"topImportMarkets",type:i.type},c={reporter:+i.reporter,partner:"all",year:i.year,commodity:"AG2",type:i.type},m="";return c.flow=1,!i.reporter||i.commodity||i.partner&&0!==+i.partner||(s.commodity="TOTAL",c.commodity="TOTAL",m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 import markets for "+{S:"services",C:"goods"}[i.type]+" in "+i.year),i.reporter&&!i.commodity&&i.partner&&0!==+i.partner?(l.html(""),void a.slideUp()):i.reporter&&i.commodity&&i.partner&&0!==+i.partner?(l.html(""),void a.slideUp()):(!i.reporter||!i.commodity||i.partner&&0!==+i.partner||(s.commodity=i.commodity,c.commodity=i.commodity,m=n.lookup(i.reporter,"reporterAreas","text")+" - Top-10 import markets for "+n.commodityName(i.commodity,i.type)+" in "+i.year),void e.query(s,function(e,o){if(e&&r.showError(e),!e&&o){var i=n.getData(c,p);l.html(m),a.find(".downloadData").unbind("click").on("click",function(e){e.preventDefault(),r.downloadCsv(m,i)}),a.slideDown(400,function(){t.draw(d,i,c,u.colors[0][0])})}}))}};return u}),define("helpers/charts",["./charts/choropleth","./charts/yearChart","./charts/infoBox","./charts/topExportCommodities","./charts/topExportMarkets","./charts/topImportCommodities","./charts/topImportMarkets"],function(e,t,r,o,n,a,i){"use strict";var l={balanceColors:["rgb(8,104,172)","rgb(120,198,121)"],importColors:["rgb(240,249,232)","rgb(186,228,188)","rgb(123,204,196)","rgb(67,162,202)","rgb(8,104,172)"],exportColors:["rgb(255,255,204)","rgb(194,230,153)","rgb(120,198,121)","rgb(49,163,84)","rgb(0,104,55)"],setup:function(s){l.colors=[l.balanceColors,l.importColors,l.exportColors],e.colors=l.colors,t.colors=l.colors,o.colors=l.colors,n.colors=l.colors,a.colors=l.colors,i.colors=l.colors,t.setup(),r.setup(),o.setup(),n.setup(),a.setup(),i.setup(),e.setup(function(){var e=l._getCssForSVGs();l._injectCSSintoSVG(e,d3.selectAll("svg")),s()})},_getCssForSVGs:function(){for(var e="",t=0;t<document.styleSheets.length;t++)if(document.styleSheets[t].href&&document.styleSheets[t].href.indexOf("main.svg.css")>=0)for(var r=0;r<document.styleSheets[t].cssRules.length;r++)e+=document.styleSheets[t].cssRules[r].cssText+" ";return e},_injectCSSintoSVG:function(e,t){t.insert("defs",":first-child").append("style").attr("type","text/css").text(e)}};return l}),define("helpers/embed",["require"],function(e){"use strict";var t={balanceColors:["rgb(8,104,172)","rgb(120,198,121)"],importColors:["rgb(240,249,232)","rgb(186,228,188)","rgb(123,204,196)","rgb(67,162,202)","rgb(8,104,172)"],exportColors:["rgb(255,255,204)","rgb(194,230,153)","rgb(120,198,121)","rgb(49,163,84)","rgb(0,104,55)"],setup:function(r){DEBUG&&console.log("This is an embed of "+r.embed),$("body").addClass("embed").addClass(r.embed+"Embedded"),$("#embedCredit").show(),$("#embedCredit a").attr("href",window.location.href.split("&embed")[0]),e(["./charts/"+r.embed],function(e){e.colors=[t.balanceColors,t.importColors,t.exportColors],e.setup(),e.refresh(null,r)})},hide:function(e){e.forEach(function(e){$("#"+e).hide()}),$("#loadingDiv").hide()}};return t}),define("helpers/intro",["require"],function(e){"use strict";var t=[{intro:'<h3>Welcome to the International Trade in Goods visualization.</h3><p style="font-size: 14px">This tool allows you to explore official trade in goods data using live data from the UN COMTRADE database.</p><p style="font-size: 14px">The tool was developed by the Department for Business Innovation and Skills (UK).</p>'},{element:document.querySelector("#controls"),intro:"The controls at the top of the page allow you to filter the data so you can focus on specific information and find what matters to you most.",position:"bottom-middle-aligned"},{element:document.querySelector("#selectReporterContainer"),intro:"Selecting a reporter is your starting point. You will need to select this to be able to select a partner, commodity and year.",position:"right"},{element:document.querySelector("#selectPartnerContainer"),intro:"Selecting a partner will allow you to see details of trade flows between your selected reporter and partner. These details will show in the Key Facts box and on the graphs below the map.",position:"bottom-middle-aligned"},{element:document.querySelector("#selectCommodityContainer"),intro:"Selecting the commodity box will display a list of classification of goods. This allows you to drill down the trade data to a greater level of detail. Selecting a commodity will update the map and the graphs below.",position:"left"},{element:document.querySelector("#flowButtons"),intro:"The map and legend will update based on whether you select exports, imports or balance.",position:"right"},{element:document.querySelector("#choroplethTitle .chartTitle"),intro:"The map visualization shows at a glance the top trading partners for the selected reporter country, and commodity if selected. You can hover over an area on the map to get quick insights into that area, or select the area as a reporter or partner.",position:"bottom-middle-aligned"},{element:document.querySelector("#infoBox"),intro:"The Key Facts box gives a breakdown of trade between your selected reporter and partner, such as export, import, balance and bilateral trade figures.",position:"right"},{element:document.querySelector("#yearChart .chartTitle"),intro:"Below the map, you will find charts showing further detail based on your filter selection. Please note that these will be displayed or hidden based on your selections. You can download these charts by selecting the arrows to the left of the charts.",position:"top"},{element:document.querySelector("#feedback-tab"),intro:"When you're done we'd really appreciate your thoughts on the visualization.",position:"left"},{intro:"Now try it yourself!"}],r={setup:function(e){var r=introJs(),o=document.cookie.replace(/(?:(?:^|.*;\s*)introDone\s*\=\s*([^;]*).*$)|^.*$/,"$1"),n=function(e){var t=e.keyCode||e.which;(["wheel","mousewheel","DOMMouseScroll"].indexOf(e.type)>-1||[32,33,34,35,36,38,40].indexOf(t)>-1)&&e.preventDefault()},a=function(){$(window).on("mousewheel.trademap DOMMouseScroll.trademap keydown.trademap",n)},i=function(){$(window).off("mousewheel.trademap DOMMouseScroll.trademap keydown.trademap")},l=function(e){var t=Math.max(0,$(e).offset().top-$(window).height()/2);"feedback-tab"===e.id&&(t=0),"infoBox"===e.id&&(t=0,$("#infoBox").css("top",$(window).height()-$("#infoBox").height()-10+"px")),$("html, body").animate({scrollTop:t},500)},s=function(){document.cookie="introDone=true; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/"},c=function(){$("html, body").animate({scrollTop:0},500),a(),r.start()},d=function(e){0===e.queryCount&&(c(),window.removeEventListener("queryQueueUpdate",d,!1))},p=function(){i(),s()};r.setOptions({skipLabel:'<span class="glyphicon glyphicon-remove"></span>',doneLabel:'<span class="glyphicon glyphicon-remove"></span>',nextLabel:'<span class="glyphicon glyphicon-arrow-right"></span>',prevLabel:'<span class="glyphicon glyphicon-arrow-left"></span>',showBullets:!1,showStepNumbers:!1,scrollToElement:!1,steps:t}),r.oncomplete(p),r.onexit(p),r.onbeforechange(l),$("#startIntro").click(function(e){e.preventDefault(),c()}),(!o||"true"===e.intro)&&$(window).width()>800&&window.addEventListener("queryQueueUpdate",d,!1)}};return r}),require.config({urlArgs:"build="+(new Date).getTime()}),require(["helpers/data","helpers/gui","helpers/controls","helpers/charts","helpers/embed","helpers/intro"],function(e,t,r,o,n,a){"use strict";"undefined"==typeof DEBUG&&(window.DEBUG=0),$(document).ready(function(){return Modernizr.svg?(Modernizr.cors||($("#userAlert").removeClass("hidden"),$("#userAlert .message").html('<strong>Warning</strong>: This application may not work correctly. Your browser does not support querying APIs which is necessary for this application to work. (Missing <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>).<br /> Please try using a recent version of Firefox or Chrome.'),$("#loadingDiv").hide()),void e.setup(function(e){if(e)return DEBUG&&console.log(e),$("#userAlert").removeClass("hidden"),void $("#userAlert .message").html("Error: Failed to load required files for startup.");var i=r.decodeURL(),l=["choropleth","yearChart","topImportCommodities","topExportCommodities","topImportMarkets","topExportMarkets"];return i.embed&&l.indexOf(i.embed)>-1?(l.splice(l.indexOf(i.embed),1),n.hide(l),void n.setup(i)):(t.setup(),a.setup(i),r.setup(),void o.setup(function(){r.initializeFilters()}))})):($("#userAlert").removeClass("hidden"),$("#userAlert .message").html("Error: it looks like your browser does not support SVG which is required for this visualization. Please consider updating to a more recent browser."),void $("#loadingDiv").hide())})}),define("main",function(){}),require(["main"]);