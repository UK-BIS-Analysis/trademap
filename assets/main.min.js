/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

var requirejs,require,define;!function(e){function t(e,t){return g.call(e,t)}function r(e,t){var r,o,a,n,i,l,s,c,d,p,u,m=t&&t.split("/"),h=f.map,y=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(e=e.split("/"),i=e.length-1,f.nodeIdCompat&&w.test(e[i])&&(e[i]=e[i].replace(w,"")),e=m.slice(0,m.length-1).concat(e),d=0;d<e.length;d+=1)if(u=e[d],"."===u)e.splice(d,1),d-=1;else if(".."===u){if(1===d&&(".."===e[2]||".."===e[0]))break;d>0&&(e.splice(d-1,2),d-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((m||y)&&h){for(r=e.split("/"),d=r.length;d>0;d-=1){if(o=r.slice(0,d).join("/"),m)for(p=m.length;p>0;p-=1)if(a=h[m.slice(0,p).join("/")],a&&(a=a[o])){n=a,l=d;break}if(n)break;!s&&y&&y[o]&&(s=y[o],c=d)}!n&&s&&(n=s,l=c),n&&(r.splice(0,l,n),e=r.join("/"))}return e}function o(t,r){return function(){var o=v.call(arguments,0);return"string"!=typeof o[0]&&1===o.length&&o.push(null),d.apply(e,o.concat([t,r]))}}function a(e){return function(t){return r(t,e)}}function n(e){return function(t){m[e]=t}}function i(r){if(t(h,r)){var o=h[r];delete h[r],y[r]=!0,c.apply(e,o)}if(!t(m,r)&&!t(y,r))throw new Error("No "+r);return m[r]}function l(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function s(e){return function(){return f&&f.config&&f.config[e]||{}}}var c,d,p,u,m={},h={},f={},y={},g=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;p=function(e,t){var o,n=l(e),s=n[0];return e=n[1],s&&(s=r(s,t),o=i(s)),s?e=o&&o.normalize?o.normalize(e,a(t)):r(e,t):(e=r(e,t),n=l(e),s=n[0],e=n[1],s&&(o=i(s))),{f:s?s+"!"+e:e,n:e,pr:s,p:o}},u={require:function(e){return o(e)},exports:function(e){var t=m[e];return"undefined"!=typeof t?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:s(e)}}},c=function(r,a,l,s){var c,d,f,g,v,w,x=[],b=typeof l;if(s=s||r,"undefined"===b||"function"===b){for(a=!a.length&&l.length?["require","exports","module"]:a,v=0;v<a.length;v+=1)if(g=p(a[v],s),d=g.f,"require"===d)x[v]=u.require(r);else if("exports"===d)x[v]=u.exports(r),w=!0;else if("module"===d)c=x[v]=u.module(r);else if(t(m,d)||t(h,d)||t(y,d))x[v]=i(d);else{if(!g.p)throw new Error(r+" missing "+d);g.p.load(g.n,o(s,!0),n(d),{}),x[v]=m[d]}f=l?l.apply(m[r],x):void 0,r&&(c&&c.exports!==e&&c.exports!==m[r]?m[r]=c.exports:f===e&&w||(m[r]=f))}else r&&(m[r]=l)},requirejs=require=d=function(t,r,o,a,n){if("string"==typeof t)return u[t]?u[t](r):i(p(t,r).f);if(!t.splice){if(f=t,f.deps&&d(f.deps,f.callback),!r)return;r.splice?(t=r,r=o,o=null):t=e}return r=r||function(){},"function"==typeof o&&(o=a,a=n),a?c(e,t,r,o):setTimeout(function(){c(e,t,r,o)},4),d},d.config=function(e){return d(e)},requirejs._defined=m,define=function(e,r,o){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");r.splice||(o=r,r=[]),t(m,e)||t(h,e)||(h[e]=[e,r,o])},define.amd={jQuery:!0}}(),define("../node_modules/almond/almond",function(){}),define("helpers/data",["require"],function(){"use strict";var e=function(){var e={queryHistory:[],queryQueue:[],queryRunning:[],timestamp:0,reporterAreasSelect:[],partnerAreasSelect:[],commodityCodesSelect:[],reporterAreas:{},partnerAreas:{},flowByCode:{},commodityCodes:{},countryByUnNum:{},countryByISONum:{},xFilter:{},xFilterByReporter:{},xFilterByPartner:{},xFilterByYear:{},xFilterByCommodity:{},xFilterByFlow:{},xFilterByAmount:{},commodityName:function(e){try{var t=this.commodityCodes.get(e).text;return t.slice(t.indexOf(" - ")+3)}catch(r){return DEBUG&&console.warn("There was a problem getting a commodity name: "+r),"unknown"}},numFormat:function(e,t,r){r=r?"."+r:".1";var o=d3.format("$,"+r+"f");return 0===e?"0":"number"!=typeof e||isNaN(e)?"No data":Math.abs(e)>=1e9?o(Math.round(e/1e8)/10)+" bn":Math.abs(e)>=1e6?o(Math.round(e/1e5)/10)+" m":Math.abs(e)>=1e3?o(Math.round(e/100)/10)+" th":(o=d3.format("$,f"))(e)},numFormatFull:function(e){var t=d3.format("$,");return t(e)},numOrdinal:function(e){if(isNaN(e)||e%1)return e;if(20>e&&e>10)return e+"th";var t=e.toString().slice(-1),r="";switch(t){case"1":r=e+"st";break;case"2":r=e+"nd";break;case"3":r=e+"rd";break;default:r=e+"th"}return r},setup:function(t){"comtrade.un.org"===location.host||Modernizr.cors||(e.baseQueryUrl="proxy.php?fmt=csv&max=50000&type=C&freq=A&px=HS&rg=1%2C2",e.useCors=!1),"comtrade.un.org"!==location.host&&Modernizr.cors&&(e.baseQueryUrl="http://comtrade.un.org/api/get?fmt=csv&max=50000&type=C&freq=A&px=HS&rg=1%2C2",e.useCors=!0),"comtrade.un.org"===location.host&&(e.baseQueryUrl="/api/get?fmt=csv&max=50000&type=C&freq=A&px=HS&rg=1%2C2",e.useCors=!1);var r={dataType:"json"};$.when($.ajax("data/reporterAreas.min.json",r),$.ajax("data/partnerAreas.min.json",r),$.ajax("data/classificationHS_AG2.min.json",r),$.ajax("data/isoCodes.csv"),$.ajax("data/world-110m.json",r)).then(function(r,o,a,n,i){e.reporterAreasSelect=r[0].results,e.partnerAreasSelect=o[0].results,e.commodityCodesSelect=a[0].results,e.worldJson=i[0];var l=d3.csv.parse(n[0]);e.countryByUnNum=d3.map(l,function(e){return e.unCode}),e.reporterAreas=d3.map(r[0].results,function(e){return e.id}),e.flowByCode=d3.map([{id:"1",text:"imports"},{id:"2",text:"exports"},{id:"0",text:"balance"}],function(e){return e.id}),e.partnerAreas=d3.map(o[0].results,function(e){return e.id}),e.commodityCodes=d3.map(a[0].results,function(e){return e.id}),e.countryByISONum=d3.map(l,function(e){return e.isoNumerical}),e.areasByISONum=function(e){return l.filter(function(t){return+t.isoNumerical===+e})},e.lookup=function(t,r,o){try{return e[r].get(t)[o]}catch(a){return"unknown"}},e.reporterAreasSelect=e.reporterAreasSelect.filter(function(e){return"all"!==e.id}),e.partnerAreasSelect=e.partnerAreasSelect.filter(function(e){return"all"!==e.id}),e.commodityCodesSelect=e.commodityCodesSelect.filter(function(e){return"ALL"!==e.id&&"AG2"!==e.id}),t()},function(){t("There was an error with one of the initial requests.")}),this.xFilter=crossfilter(),this.xFilterByReporter=this.xFilter.dimension(function(e){return+e.reporter}),this.xFilterByPartner=this.xFilter.dimension(function(e){return+e.partner}),this.xFilterByYear=this.xFilter.dimension(function(e){return+e.year}),this.xFilterByCommodity=this.xFilter.dimension(function(e){return e.commodity}),this.xFilterByFlow=this.xFilter.dimension(function(e){return+e.flow}),this.xFilterByAmount=this.xFilter.dimension(function(e){return+e.value})},query:function(t,r){var o=this._buildUrl(t),a=new Date;if(e.queryHistory.indexOf(o)>-1)return void r(null,!0);var n=a.getTime()-e.timestamp;return 1100>n||e.queryRunning.indexOf(o)>-1?(window.setTimeout(function(){e.query(t,r)},n+100),this.queryQueue.indexOf(o)<0&&(this.queryQueue.push(o),this._fireQueryQueueUpdateEvent()),void r(null,!1)):void $.ajax({url:o,timeout:75e3,crossDomain:e.useCors,context:this,beforeSend:function(e){this.timestamp=a.getTime(),this.queryRunning.push(o),$("#loadingDiv #cancelRequest").on("click",function(){e.abort(),$("#loadingDiv").fadeOut()}),$("#loadingDiv").fadeIn()},success:function(e){this._addData(e,t),this.queryHistory.push(o),r(null,!0)},error:function(t,a,n){409===t.status?(DEBUG&&console.log("API 409 Error: Requeueing the request."),e.query(o,r),r(null,!1)):r(a+" "+n,null)},complete:function(){var e=this.queryRunning.indexOf(o);e>-1&&this.queryRunning.splice(e,1);var t=this.queryQueue.indexOf(o);t>-1&&this.queryQueue.splice(t,1),this._fireQueryQueueUpdateEvent(),0===this.queryQueue.length&&0===this.queryRunning.length&&($("#loadingDiv").fadeOut(),$("#loadingDiv #cancelRequest").off("click"))}})},getData:function(e,t){this.xFilterByReporter.filterAll(),this.xFilterByPartner.filterAll(),this.xFilterByYear.filterAll(),this.xFilterByCommodity.filterAll(),this.xFilterByFlow.filterAll(),this.xFilterByAmount.filterAll(),"undefined"!=typeof e.reporter&&this.xFilterByReporter.filter(+e.reporter),"undefined"!=typeof e.partner&&"all"===e.partner&&this.xFilterByPartner.filter(function(e){return 0!==+e}),"undefined"!=typeof e.partner&&"all"!==e.partner&&this.xFilterByPartner.filter(+e.partner),"undefined"!=typeof e.year&&"all"!==e.year&&this.xFilterByYear.filter(+e.year),"undefined"!=typeof e.commodity&&"AG2"!==e.commodity&&this.xFilterByCommodity.filter(e.commodity),"undefined"!=typeof e.commodity&&"AG2"===e.commodity&&this.xFilterByCommodity.filter(function(e){return"TOTAL"!==e}),"undefined"==typeof e.commodity&&this.xFilterByCommodity.filter(function(e){return"TOTAL"===e}),"undefined"!=typeof e.flow&&0!==+e.flow&&this.xFilterByFlow.filter(e.flow),t||(t=1/0);var r=this.xFilterByAmount.top(t);return r},combineData:function(e){var t=[],r=d3.map(),o=0,a=0,n={};return e=e.filter(function(e){return 0!==+e.partner?!0:(1===e.flow&&(o=e.value,n.reporter=e.reporter,n.partner=e.partner,n.commodity=e.commodity,n.year=e.year,n.importVal=e.value),2===e.flow&&(a=e.value,n.reporter=e.reporter,n.partner=e.partner,n.commodity=e.commodity,n.year=e.year,n.exportVal=e.value),!1)}),n.bilateralVal=n.importVal+n.exportVal,n.balanceVal=n.exportVal-n.importVal,e.forEach(function(e){var t=["importVal","exportVal"][+e.flow-1],o=$.extend({},e);if(o.importVal=null,o.exportVal=null,o[t]=o.value,delete o.value,r.has(o.partner)){var a=r.get(o.partner);a[t]=o[t],r.set(a.partner,a)}else r.set(o.partner,o)}),t=r.values(),t=t.map(function(e){return e.importVal&&e.exportVal&&(e.bilateralVal=e.exportVal+e.importVal,e.balanceVal=e.exportVal-e.importVal),e.importVal&&0!==o&&(e.importPc=e.importVal/o*100),e.exportVal&&0!==a&&(e.exportPc=e.exportVal/a*100),e}),t.sort(function(e,t){return+(t.importVal>e.importVal)||+(t.importVal===e.importVal)-1}),t.forEach(function(e,r){e.importVal&&(t[r].importRank=r+1)}),t.sort(function(e,t){return+(t.exportVal>e.exportVal)||+(t.exportVal===e.exportVal)-1}),t.forEach(function(e,r){e.exportVal&&(t[r].exportRank=r+1)}),t.push(n),t},_buildUrl:function(t){var r=e.baseQueryUrl;return r+="undefined"!=typeof t.reporter?"&r="+t.reporter:"&r=0",r+="undefined"!=typeof t.partner?"&p="+t.partner:"&p=all",r+="undefined"!=typeof t.year&&null!==t.year?"&ps="+t.year:"&ps=now",r+="undefined"!=typeof t.commodity?"&cc="+t.commodity:"&cc=AG2"},_addData:function(e,t){var r=d3.csv.parse(e,function(e){return{reporter:+e["Reporter Code"],partner:+e["Partner Code"],year:+e.Year,commodity:e["Commodity Code"],flow:+e["Trade Flow Code"],value:+e["Trade Value (US$)"]}}),o=$.extend({},t);"all"==o.partner&&delete o.partner;var a=this.getData(o),n=[],i=r.filter(function(e){var t=!1;return a.forEach(function(r){e.reporter===r.reporter&&e.partner===r.partner&&e.commodity===r.commodity&&e.flow===r.flow&&e.year===r.year&&e.value===r.value&&(t=!0,n.push(e))}),!t});this.xFilter.add(i),DEBUG&&(console.groupCollapsed("API QUERY SUCCESS from %s: r=%s p=%s c=%s y=%s",t.initiator,t.reporter,t.partner,t.commodity,t.year),console.log("filters: %o",t),console.log("Added %d new records. Retrieved %d records. Checked %d possible matches and discarded %d duplicates. New xFilter size: %d",i.length,r.length,a.length,n.length,this.xFilter.size()),console.log("duplicates discarded: %o",n),console.groupEnd())},_fireQueryQueueUpdateEvent:function(){var e=document.createEvent("Events");e.initEvent("queryQueueUpdate",!0,!0),e.queryCount=this.queryQueue.length+this.queryRunning.length,window.dispatchEvent(e)}};return e};return e()}),define("helpers/gui",[],function(){"use strict";var e={setup:function(){fontFaceCheck.support(!1,function(e){e||$("body").addClass("no-fontsupport")}),$(window).bind("mousewheel DOMMouseScroll keydown",function(e){var t=e.keyCode||e.which;1==e.ctrlKey&&(["wheel","mousewheel","DOMMouseScroll"].indexOf(e.type)>-1||[107,189,187,173,61].indexOf(t)>-1)&&(e.preventDefault(),DEBUG&&console.log("Sorry, zooming is disabled on this app."))}),$("#footer").show(),$("#goToCharts a, #goToMap a").tooltip(),$(".titleDropdown button").tooltip(),$("#goToCharts a, #goToMap a, #goToFooter").on("click",function(e){e.preventDefault();var t=this.hash;$("html, body").animate({scrollTop:$(t).offset().top},1e3)}),$("#facebookShareLink").on("click",function(e){e.preventDefault();var t=screen.height/2-260,r=screen.width/2-175;window.open("https://www.facebook.com/sharer/sharer.php?u="+window.location.href,"sharer","top="+t+",left="+r+",toolbar=0,status=0,width=520,height=350")}),$("#tweetLink").on("click",function(e){e.preventDefault();var t=screen.height/2-260,r=screen.width/2-175;window.open("https://twitter.com/share?text=Check%20out%20the%20International%20Trade%20in%20Goods%20DataViz&url="+window.location.href,"sharer","top="+t+",left="+r+",toolbar=0,status=0,width=520,height=350")}),window.addEventListener("queryQueueUpdate",function(e){var t=$("#loadingDiv .progress-bar");if(0===e.queryCount)return void t.attr("aria-valuenow",0).attr("aria-valuemax",0).css("width","100%");var r=Math.max(parseInt(t.attr("aria-valuemax"),10),e.queryCount),o=r-e.queryCount,a=o/r*100+"%";t.attr("aria-valuenow",o).attr("aria-valuemax",r).css("width",a)},!1),/AppleWebKit/.test(navigator.userAgent)||$('a.downloadChart[data-format="png"]').parent().addClass("disabled").attr("title","This option is not available on your browser.").attr("data-toggle","tooltip").attr("data-placement","right").tooltip(),Modernizr.blobconstructor?$("a.downloadChart").on("click",function(){var e=$(this).attr("data-target"),t=$(this).attr("data-format"),r=$("#"+e+" .chartTitle").text(),o=$("#"+e+" .svgChart"),a=o.width(),n=o.height(),i=n,l=document.createRange(),s=document.createElement("div");l.selectNode(o[0]);var c=l.cloneContents();"choropleth"===e&&("svg"===t&&(a=1280,n=720,$(c).children("svg").removeAttr("viewBox").removeAttr("preserveAspectRatio").attr("width",a).attr("height",n)),i=645,$(c).children("svg").append('<g class="legend" transform="translate(25,25) scale(1.5)">'+$("#mapLegendSvg g.legend")[0].innerHTML+"</g>")),$(c).children("svg").attr("height",n+75).append('<text y="'+i+'"><tspan x="10" class="creditTitle">'+r+'</tspan><tspan x="10" dy="15" class="creditSource">International Trade in Goods based on UN Comtrade data</tspan><tspan x="10" dy="15" class="creditSource">Developed by the Department for Business Innovation and Skills (UK)</tspan><tspan x="10" dy="15" class="creditLink">'+document.location.href+"</tspan></text>"),s.appendChild(c.cloneNode(!0));var d=s.innerHTML;if("svg"==t){var p=new Blob([d],{type:"image/svg+xml;charset=utf8"});return void saveAs(p,e+".svg")}if("png"==t){var u=new Image;u.onload=function(){var t=document.createElement("canvas");t.width=a,t.height=n+75;var r=t.getContext("2d");r.drawImage(u,0,0);var o=document.createElement("a");o.download=e+".png";var i=t.toDataURL("image/png");o.href=i,document.body.appendChild(o),o.click()},u.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(d)))}}):$("a.downloadChart").parent().addClass("disabled").attr("title","This option is not available on your browser.").attr("data-toggle","tooltip").attr("data-placement","right").tooltip(),$("a.embedSvg").on("click",function(e){e.preventDefault(),$("#myModal #myModalLabel").html("Embed this chart"),$("#myModal .modal-body").html("<p>Copy and paste the following code:</p><pre>&lt;iframe src=&quot;"+window.location.href+"&amp;embed="+$(this).attr("data-target")+'&quot; height=&quot;500&quot; width=&quot;100%&quot;&gt;&lt;/iframe&gt;</pre><p>Preview:</p><iframe src="'+window.location.href+"&embed="+$(this).attr("data-target")+'" height="500" width="100%"></iframe>'),$("#myModal").modal("show")}),$("body").on("hidden.bs.modal",".modal",function(){$(this).removeData("bs.modal")})},showError:function(e){$("#myModalLabel").html('<span class="glyphicon glyphicon-warning-sign"></span> There was an error in querying the COMTRADE API.'),$("#myModal .modal-body").html("Charts may not display correctly, please try reloading the page or trying again later.<br /><small>Error details: "+e+"</small>"),$("#myModal").modal({show:!0})},downloadCsv:function(e,t){var r="data:text/csv;charset=utf-8,\nreporter,partner,flow,commodity,year,value\n";t.forEach(function(e){r+=e.reporter+","+e.partner+","+e.flow+","+e.commodity+","+e.year+","+e.value+"\n"});var o=encodeURI(r),a=document.createElement("a");a.setAttribute("href",o),a.setAttribute("download",e+".csv"),document.body.appendChild(a),a.click()}};return e}),define("helpers/controls",["./data"],function(e){"use strict";var t={$selectReporter:$("#selectReporter"),$selectPartner:$("#selectPartner"),$selectCommodity:$("#selectCommodity"),$selectYear:$("#selectYear"),$selects:$("#selectReporter, #selectPartner, #selectCommodity, #selectYear"),$flowButtons:$("#flowButtons"),$clearFilters:$("#clearFilters"),filters:{},setup:function(){$("#navbar").show(),this.$selectReporter.select2({placeholder:"Select a reporter",allowClear:!0,data:e.reporterAreasSelect}).on("change",t.onFilterChange),this.$selectPartner.select2({placeholder:"Select a partner",allowClear:!0,disabled:!0,data:e.partnerAreasSelect}).on("change",t.onFilterChange).select2("disable"),this.$selectCommodity.select2({placeholder:"Select a commodity",allowClear:!0,data:e.commodityCodesSelect}).on("change",t.onFilterChange).select2("disable"),this.$selectYear.select2({allowClear:!1,minimumResultsForSearch:1/0,disabled:!0}).on("change",t.onFilterChange),$("#switchPartners").on("click",function(){var e=t.getFilters();t.changeFilters({reporter:e.partner,partner:e.reporter,year:e.year,flow:e.flow})}),this.$flowButtons.on("click",function(e){$("#flowButtons button").removeClass("btn-primary").addClass("btn-default"),$(e.target).closest("button").removeClass("btn-default").addClass("btn-primary"),t.onFilterChange()}),this.$clearFilters.on("click",function(){$("#selectReporter, #selectPartner, #selectCommodity").off("change",t.onFilterChange).val(null).trigger("change").on("change",t.onFilterChange),t.onFilterChange()}),$("#closeContextMenu").on("click",function(e){e.preventDefault(),$("#contextMenu").hide()}),$("#contextMenu .setReporter").on("click",function(e){e.preventDefault(),$(e.target.parentNode).hasClass("disabled")||t.changeFilters({reporter:$(e.target).attr("data-uncode")}),$("#contextMenu").hide()}),$("#contextMenu .setPartner").on("click",function(e){e.preventDefault(),$(e.target.parentNode).hasClass("disabled")||t.changeFilters({partner:$(e.target).attr("data-uncode")}),$("#contextMenu").hide()})},getFilters:function(){var e={};return""!==t.$selectReporter.val()&&(e.reporter=t.$selectReporter.val()),""!==t.$selectPartner.val()&&(e.partner=t.$selectPartner.val()),""!==t.$selectCommodity.val()&&(e.commodity=t.$selectCommodity.val()),""!==t.$selectYear.val()&&(e.year=t.$selectYear.val()),""!==$("#flowButtons .btn-primary").attr("data-value")&&(e.flow=$("#flowButtons .btn-primary").attr("data-value")),e},onFilterChange:function(){var e=t.getFilters();(t.filters.reporter!==e.reporter||t.filters.partner!==e.partner||t.filters.commodity!==e.commodity||t.filters.year!==e.year||t.filters.flow!==e.flow)&&(!t.filters.partner&&e.partner&&$("html, body").animate({scrollTop:$("#charts").offset().top},2e3),t.fadeControls(e),t.showElements(e),$(".chart").trigger("refreshFilters",e),t.updateURL(e),t.filters=e)},changeFilters:function(e){(e.reporter||""!==t.$selectReporter.val())&&(e.reporter&&e.reporter!==t.$selectReporter.val()&&t.$selectReporter.val(e.reporter),e.commodity&&e.commodity!==t.$selectCommodity.val()&&t.$selectCommodity.val(e.commodity),e.partner&&e.partner!==t.$selectPartner.val()&&t.$selectPartner.val(e.partner),e.year&&e.year!==t.$selectYear.val()&&(t.updateYears([+t.$selectYear.val(),e.year]),t.$selectYear.val(e.year)),t.$selects.trigger("change"))},initializeFilters:function(){var e=this.decodeURL();e&&e.reporter?this.changeFilters(e):t.changeFilters({reporter:826,year:2014})},decodeURL:function(){var e=window.History;try{var t={},r=e.getState();return r.hash.split("?",2)[1].split("&").forEach(function(e){e=e.replace(/%20|\+/g," ").split("="),t[decodeURIComponent(e[0])]=e[1]?decodeURIComponent(e[1]):void 0}),t.year&&(t.year=+t.year),t}catch(o){return{}}},updateURL:function(e){var t=window.History,r="?",o="";for(o in e)r+=encodeURIComponent(o),e[o]&&(r+="="+encodeURIComponent(e[o])),r+="&";r=r.slice(0,-1),t.replaceState(null,"International Trade in Goods by Country and Commodity",r)},updateYears:function(e){if(e.length>0){var r=+t.$selectYear.val();t.$selectYear.html(""),e.sort(function(e,t){return t-e}).forEach(function(e){t.$selectYear.append('<option value="'+e+'">'+e+"</option>")}),e.indexOf(r)>=0?t.$selectYear.val(+r):t.$selectYear.val(d3.max(e)).trigger("change")}},fadeControls:function(r){r.reporter?($("#selectCommodity").select2("enable"),$("#selectPartner").select2("enable"),$("#selectYear").select2("enable"),r.partner&&"unknown"!=e.lookup(r.partner,"reporterAreas","id")?$("#switchPartners").prop("disabled",!1):$("#switchPartners").prop("disabled",!0)):($("#selectReporter, #selectPartner, #selectCommodity").off("change",t.onFilterChange).val(null).trigger("change").on("change",t.onFilterChange),$("#selectCommodity").select2("disable"),$("#selectPartner").select2("disable"),$("#selectYear").select2("disable"),$("#switchPartners").prop("disabled",!0))},showElements:function(e){e.reporter?($("#goToCharts, #goToMap, #flowButtons").show(),$("#charts").slideDown(),$("#contextMenu .setPartner").removeClass("disabled")):($("#goToCharts, #goToMap, #flowButtons").hide(),$("#charts").slideUp(),$("#contextMenu .setPartner").addClass("disabled"))},showError:function(e){$("#myModalLabel").html('<span class="glyphicon glyphicon-warning-sign"></span> There was an error in querying the COMTRADE API.'),$("#myModal .modal-body").html(e),$("#myModal").modal({show:!0})}};return t}),define("helpers/charts/infoBox",["../data","../gui","../controls"],function(e,t){"use strict";var r=e,o=$("#infoBox"),a=$("#defaultPanel"),n=$("#hoverPanel"),i=10,l=function(){return $(document).width()>992?Math.min($("#infoBoxPlaceholder").offset().top,$(window).height()-o.height()-i+$(window).scrollTop())+"px":$("#infoBoxPlaceholder").offset().top},s=function(){return $("#infoBoxPlaceholder").width()-20+"px"},c=function(){o.css({top:l(),width:s()})},d={setup:function(){o.show().css({top:$(window).height()-o.height()-i+$(window).scrollTop(),width:s()}),$(window).scroll(c),n.slideUp(),$(window).on("resize",c),setTimeout(c,800),o.on("refreshFilters",this.refresh)},refresh:function(n,i){if(!i.reporter)return void o.slideUp();o.slideDown();var l={reporter:+i.reporter,partner:0,year:+i.year,commodity:"AG2",initiator:"infoBox"},s={reporter:+i.reporter,year:+i.year,commodity:"TOTAL"};i.partner&&0!==i.partner||(s.partner=0),!i.reporter||i.commodity||i.partner||(l.commodity="TOTAL",l.year="all"),i.reporter&&!i.commodity&&i.partner&&(l.partner="all",l.commodity="TOTAL",l.year=+i.year),i.reporter&&i.commodity&&i.partner&&(l.partner="all",l.commodity=i.commodity,s.commodity=i.commodity),i.reporter&&i.commodity&&!i.partner&&(l.partner="all",l.commodity=i.commodity,s.commodity=i.commodity),e.query(l,function(e,o){if(e&&t.showError(e),!e&&o){var n=r.getData(s),l=r.combineData(n),c=d3.map(l,function(e){return e.partner});d.populateBox(a,c.get(i.partner||0),i.partner)}})},populateBox:function(e,t,o){if(e.find(".subtitle").html(""),e.find(".value").html(""),e.find(".ranking").html(""),e.find("dt").show(),!t)return e.find(".subtitle").html('<p class="text-center"><strong>No data available for '+r.lookup(o,"countryByUnNum","name")+".</strong></p>"),e.find(".value, .ranking").html(""),void e.find("dt").hide();var a=r.lookup(t.reporter,"reporterAreas","text"),n=r.lookup(t.partner,"partnerAreas","text"),i="<strong>"+a+"</strong> trade in goods with <strong>"+n+"</strong> in <strong>"+t.year+"</strong><br />";if(t.commodity&&"TOTAL"!==t.commodity&&(i+="<strong>"+r.commodityName(t.commodity)+"</strong>"),e.find(".subtitle").html(i),e.find(".value.exports").html(r.numFormat(t.exportVal,null,1)),e.find(".value.imports").html(r.numFormat(t.importVal,null,1)),e.find(".value.balance").html(r.numFormat(t.balanceVal,null,1)),e.find(".value.bilateral").html(r.numFormat(t.bilateralVal,null,1)),t.partner&&0!==t.partner&&t.importRank&&t.exportRank){var l=n+" was the "+r.numOrdinal(t.exportRank)+" largest export market for "+a+" ("+t.exportPc.toFixed(1)+"% of "+a+" exports) and the "+r.numOrdinal(t.importRank)+" largest import market for "+a+" ("+t.importPc.toFixed(1)+"% of "+a+" imports)";t.commodity&&"TOTAL"!==t.commodity&&(l+=" for "+r.commodityName(t.commodity)),l+=" in "+t.year+".",e.find(".ranking").html(l)}},displayHover:function(e,t){d.populateBox(n,e,t),a.stop().slideUp(),n.stop().slideDown()},hideHover:function(){n.stop().slideUp(),a.stop().slideDown()}};return d}),define("helpers/charts/choropleth",["../data","../gui","./infoBox","../controls"],function(e,t,r){"use strict";var o=e,a=$("#choropleth"),n=$("#choroplethTitle .chartTitle"),i=720,l=1280,s=d3.select("#choropleth .chart").append("svg").classed("choropleth",!0).classed("svgChart",!0).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr("id","choroplethSvg").attr("viewBox","0 0 "+l+" "+i).attr("preserveAspectRatio","xMidYMid meet"),c={setup:function(t){a.show(),a.on("refreshFilters",this.refresh);var n=d3.geo.kavrayskiy7().scale(230).translate([l/2+50,i/2]).precision(.1),c=d3.geo.path().projection(n),d=function(){s.attr("width",a.width()).attr("height",a.height())};d(),d3.select(window).on("resize",d),s.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",c).attr("stroke","#054D82").attr("stroke-width","1.5px").attr("fill","none"),s.append("use").attr("class","stroke").attr("xlink:href","#sphere"),s.append("use").attr("class","fill").attr("xlink:href","#sphere");var p=topojson.feature(e.worldJson,e.worldJson.objects.countries).features;s.append("g").attr("class","countries").selectAll(".country").data(p).enter().append("path").attr("class","country").attr("d",c).attr("id",function(e){return"iso"+e.id}).on("click",function(e){d3.event.preventDefault(),$("#contextMenu .country").html(o.lookup(e.id,"countryByISONum","name")),$("#contextMenu .setReporter a, #contextMenu .setPartner a").attr("data-uncode",o.lookup(e.id,"countryByISONum","unCode")),$("#closeContextMenu").on("click",function(e){e.preventDefault(),r.hideHover()}),$("#contextMenu").css({display:"block",left:d3.event.pageX,top:d3.event.pageY})}),t&&t()},refresh:function(r,i){var l={reporter:+i.reporter,partner:"all",year:+i.year,initiator:"choropleth"},d={reporter:+i.reporter,partner:"all",year:+i.year,flow:+i.flow},p="";return i.reporter?(i.reporter&&!i.commodity&&(l.commodity="TOTAL",d.commodity="TOTAL",p=o.lookup(i.reporter,"countryByUnNum","name")+[" trade in goods balance "," imports of goods "," exports of goods "][i.flow]+" in "+i.year),i.reporter&&i.commodity&&(l.commodity=i.commodity,d.commodity=i.commodity,p=o.lookup(i.reporter,"countryByUnNum","name")+[" trade in "+o.commodityName(i.commodity)+" balance "," imports of "+o.commodityName(i.commodity)+" "," exports of "+o.commodityName(i.commodity)+" "][i.flow]+" in "+i.year),void e.query(l,function(e,r){if(e&&t.showError(e),!e&&r){c._redrawMap(d),n.html(p);var i=o.getData(d);a.find(".downloadData").unbind().on("click",function(e){e.preventDefault(),t.downloadCsv(p,i)})}})):(s.selectAll(".country").style("fill","#fff"),s.selectAll(".highlighted").classed("highlighted",!1),void n.html(""))},_redrawMap:function(e){var t,a;1===+e.flow&&(t="importRank",a="importVal"),2===+e.flow&&(t="exportRank",a="exportVal"),0===+e.flow&&(t="balanceVal",a="balanceVal");var n=o.getData({reporter:e.reporter,commodity:e.commodity,year:+e.year});n=o.combineData(n),n=n.filter(function(e){return e[t]&&e[a]&&0!==e.partner});var i,l,d=d3.map(n,function(e){return e.partner}),p=n.length,u=d3.scale.threshold();0===+e.flow?u.domain([0]).range([0,1]):(p>25&&(i=[4,p/4,p/2,3*p/4],l=[4,3,2,1,0]),25>=p&&p>4&&(i=[p/4,p/2,3*p/4],l=[3,2,1,0]),4>=p&&(i=[p],l=[0]),u=d3.scale.threshold().domain(i).range(l)),s.selectAll(".country").classed("highlighted",!1).on("mouseenter",function(e){try{var t=o.countryByISONum.get(e.id).unCode,a=d.get(t);a?r.displayHover(a):r.displayHover(!1,t),s.selectAll(".country").sort(function(t,r){return(t.id===e.id)-(r.id===e.id)})}catch(n){r.displayHover(!1),DEBUG&&console.log("No country in database by "+e.id+" isoCode.")}}).on("mouseleave",function(){r.hideHover()}).transition().duration(1e3).style("fill",function(r){var a=o.areasByISONum(r.id),n=[],i=0;try{if(a.forEach(function(e){var t=d.get(e.unCode);t&&n.push(d.get(e.unCode))}),0===n.length)throw"No data points for "+o.lookup(r.id,"countryByUnNum","name");if(n.length>1)throw"Multiple data points for "+o.lookup(r.id,"countryByUnNum","name");if(null===n[0][t])throw"Incomplete data for "+o.lookup(r.id,"countryByUnNum","name");return i=u(n[0][t]),c.colors[e.flow][i]}catch(l){return"#818181"}});var m=d3.nest().key(function(e){return u(e[t])}).rollup(function(e){return{min:d3.min(e,function(e){return e[a]}),max:d3.max(e,function(e){return e[a]}),count:e.length}}).entries(n);c._drawLegend(m,e.flow),s.select("#iso"+o.lookup(e.reporter,"countryByUnNum","isoNumerical")).classed("highlighted",!0)},_drawLegend:function(e,t){var r=d3.select("#mapLegend svg"),a=30,n=5,i=c.colors[t].slice(0,e.length),l=["Balance","Imports","Exports"][t],s=e.reduce(function(e,t){return e+t.values.count},0);r.attr("height",(e.length+1)*(a+n)+25).attr("width",225),r.select("g.legend").remove(),r.select("text.title").remove(),r.append("text").attr("class","title").attr("x",0).attr("y",18).style("font-weight","bold").text(l+" Legend");var d=r.append("g").attr("class","legend").attr("transform","translate(0,25)");d.append("rect").attr("class","noData").attr("x",0).attr("y",0).attr("rx",1).attr("ry",1).attr("width",8).attr("height",15).style("fill","#818181"),d.append("text").attr("class","noData").attr("x",12).attr("y",13).text("No data available"),d=d.append("g").attr("class","scale").attr("transform","translate(0,18)"),d.selectAll("rect").data(d3.range(i.length)).enter().append("rect").attr("x",0).attr("y",function(e,t){return 33*t}).attr("rx",1).attr("ry",1).attr("width",8).attr("height",30).style("fill",function(e,t){return i[t]});var p=d.selectAll("text").data(d3.range(i.length)).enter().append("text").attr("y",function(e,t){return 33*t+14});p.append("tspan").attr("class","line1").attr("x",12).text(function(r,a){return+t>0?o.numFormat(e[a].values.min,null,1)+" - "+o.numFormat(e[a].values.max,null,1)+" ("+e[a].values.count+" partners)":void 0}),p.append("tspan").attr("class","line1").attr("x",12).attr("dy",15).text(function(r,o){if(0===+t)return["Deficit","Surplus"][o]+" ("+e[o].values.count+" partners)";var a="";switch(o){case 0:a=4>s?"Not enough data to map":"Up to 25th percentile";break;case 1:a="25th to 50th percentile";break;case 2:a="50th to 75th percentile";break;case 3:a="Above 75th percentile excl. top 3";break;case 4:var n=3/s*100;a="Top 3 - above "+n.toFixed(1)+" percentile"}return a})}};return c}),define("helpers/charts/yearChart",["../data","../gui","../controls"],function(e,t,r){"use strict";var o=e,a=$("#yearChart"),n=a.children(".chart"),i=a.children(".chartTitle"),l=d3.select("#yearChart .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0),s={top:25,right:15,bottom:75,left:70},c=n.height(),d=n.width(),p=c-s.top-s.bottom,u=d-s.left-s.right,m=d3.scale.linear().range([0,u]).clamp(!0),h=d3.scale.linear().range([p,0]),f=d3.svg.axis().scale(m).orient("bottom").tickFormat(d3.format(".0f")),y=d3.svg.axis().scale(h).orient("left").ticks(6).tickFormat(o.numFormat),g=d3.svg.line().interpolate("linear"),v={setup:function(){n.on("refreshFilters",this.refresh),$(window).on("resize",this.resizeSvg),l.attr("width",d).attr("height",c),l.append("g").attr("class","x axis").attr("transform","translate("+s.left+","+(s.top+p)+")").call(f),l.append("g").attr("class","y axis").attr("transform","translate("+s.left+","+s.top+")").call(y),l.append("g").attr("class","plots").attr("transform","translate("+s.left+","+s.top+")");var e=l.append("g").attr("class","legend").attr("transform","translate("+(u+s.left-120*v.colors[0].length)+",0)").selectAll(".legendItem").data(v.colors[0]).enter().append("g").attr("class","legendItem");
e.append("circle").attr("cx",function(e,t){return 120*t}).attr("cy","10").attr("r","5").style("fill",function(e){return e}),e.append("text").attr("transform",function(e,t){return"translate("+(120*t+10)+",15)"}).text(function(e,t){return["Imports","Exports"][t]}),a.slideUp(0)},refresh:function(r,n){if(!n.reporter)return void a.slideUp();var l={reporter:+n.reporter,year:"all",initiator:"yearChart"},s={reporter:+n.reporter,year:"all"},c="";!n.reporter||n.commodity||n.partner||(c=o.lookup(n.reporter,"reporterAreas","text")+" trade in goods with the world",l.partner=0,l.commodity="TOTAL",s=l),n.reporter&&!n.commodity&&n.partner&&(c=o.lookup(n.reporter,"reporterAreas","text")+" trade in goods with "+o.lookup(n.partner,"partnerAreas","text"),l.partner=n.partner,l.commodity="TOTAL",s.partner=+n.partner,s.commodity="TOTAL"),n.reporter&&n.commodity&&n.partner&&(c=o.lookup(n.reporter,"reporterAreas","text")+" trade in "+o.commodityName(n.commodity)+" with "+o.lookup(n.partner,"partnerAreas","text"),l.partner=+n.partner,l.commodity=n.commodity,s.partner=+n.partner,s.commodity=n.commodity),n.reporter&&n.commodity&&!n.partner&&(c=o.lookup(n.reporter,"reporterAreas","text")+" trade in "+o.commodityName(n.commodity)+" with the world",l.partner=0,l.commodity=n.commodity,s.partner=0,s.commodity=n.commodity),e.query(l,function(e,r){if(e&&t.showError(e),!e&&r){var n=o.getData(s),l=d3.min(n,function(e){return e.year});c+=" since "+l,i.html(c),a.find(".downloadData").on("click",function(e){e.preventDefault(),t.downloadCsv(c,n)}),a.slideDown(400,function(){v._draw(n)})}})},_draw:function(e){if(0===e.length)return l.append("text").text("No data available for this chart.").classed("nodata",!0).classed("label",!0).attr("x",u/2+s.left-75).attr("y",p/2+s.top-75),void l.selectAll(".flow").remove();l.selectAll(".nodata").remove();var t=d3.nest().key(function(e){return e.flow}).sortValues(function(e,t){return e.year-t.year}).entries(e),a=d3.extent(e,function(e){return e.year}),n=d3.range(a[0],a[1]+1),i=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return e.year+": "+o.numFormat(e.value,null,1)+" "+["imports","exports"][e.flow-1]});m.domain([a[0],a[1]+1]),h.domain([0,d3.max(e,function(e){return e.value})]),g.x(function(e){return m(e.year)}).y(function(e){return h(e.value)}),f.scale(m).tickValues(n).tickSize(6,0).tickFormat(d3.format(".0f")),y.scale(h).tickSize(6,0).tickFormat(o.numFormat),r.updateYears(n),l.select(".x.axis").transition().call(f).selectAll("g.x text").attr("transform","rotate(-65) translate(-22,-10)"),l.select(".y.axis").transition().call(y);var c=l.selectAll("line.yearHighlight").data([1]),d=$("#selectYear").val();c.enter().append("line").attr("class","yearHighlight").attr("x1","0").attr("y1",s.top).attr("x2","0").attr("y2",s.top+p).attr("stroke","#054D82").attr("stroke-dasharray","5, 5").attr("stroke-width","1"),c.transition().attr("x1",function(){return m(+d)+s.left}).attr("x2",function(){return m(+d)+s.left});var w=l.select(".plots"),x=w.selectAll("path.flow").data(t);x.enter().append("path").attr("class","flow").style("stroke",function(e){return v.colors[0][e.key-1]}).style("fill","none").style("stroke-width","1.5px"),x.transition().attr("d",function(e){return g(e.values)});var b=w.selectAll("g.flow").data(t);b.enter().append("g").attr("class","flow");var C=b.selectAll("circle.dot").data(function(e){return e.values});C.enter().append("circle").attr("class","dot").attr("r","3").style("fill",function(e){return v.colors[0][e.flow-1]}).style("stroke-width","0").on("mouseover",function(e){i.show(e),d3.select(this).interrupt().transition().attr("r","6")}).on("mouseout",function(e){i.hide(e),d3.select(this).interrupt().transition().attr("r","3")}).on("click",function(e){r.changeFilters({year:e.year})}),C.transition().attr("cx",function(e){return m(e.year)}).attr("cy",function(e){return h(e.value)}),C.exit().remove(),w.call(i)},resizeSvg:function(){d=n.width(),l.attr("width",d),u=d-s.left-s.right,m.range([0,u]),f.scale(m),l.select(".x.axis").transition().call(f),l.select("g.legend").attr("transform","translate("+(u+s.left-120*v.colors[0].length)+",0)"),l.selectAll("circle.dot").transition().attr("cx",function(e){return m(e.year)}),g.x(function(e){return m(e.year)}),l.selectAll("path.flow").transition().attr("d",function(e){return g(e.values)});var e=$("#selectYear").val();l.selectAll("line.yearHighlight").transition().attr("x1",function(){return m(+e)+s.left}).attr("x2",function(){return m(+e)+s.left})}};return v}),define("helpers/rowchart",["./data","./controls"],function(e,t){"use strict";var r=e,o={margin:{top:25,right:60,bottom:75,left:35},innerHeight:0,innerWidth:0,xScale:d3.scale.linear(),yScale:d3.scale.linear(),xAxis:d3.svg.axis().tickSize(0,0).tickFormat(""),yAxis:d3.svg.axis(),barHeight:0,setup:function(e){o.innerHeight=e.attr("height")-o.margin.top-o.margin.bottom,o.innerWidth=e.attr("width")-o.margin.left-o.margin.right,o.xScale.range([0,o.innerWidth]),o.yScale.range([0,o.innerHeight]).clamp(!0),o.xAxis.scale(o.xScale).orient("bottom").tickFormat(r.numFormat),o.yAxis.scale(o.yScale).orient("left"),e.append("g").attr("class","bars").attr("transform","translate("+o.margin.left+","+o.margin.top+")"),e.append("g").attr("class","x axis").attr("transform","translate("+o.margin.left+","+(o.innerHeight+o.margin.top)+")").call(o.xAxis),e.append("g").attr("class","y axis").attr("transform","translate("+o.margin.left+","+o.margin.top+")").call(o.yAxis)},draw:function(e,a,n,i){o.xScale.domain([0,d3.max(a,function(e){return e.value})]).nice(),o.yScale.domain([0,d3.max([10,a.length])]).clamp(!0).nice(),o.xAxis.scale(o.xScale).tickSize(6,0).tickFormat(r.numFormat),o.yAxis.scale(o.yScale).ticks(0),o.barHeight=o.yScale(1)-20,e.select("text.nodata").remove(),e.select(".x.axis").transition().call(o.xAxis).selectAll("text").attr("transform","rotate(-65) translate(-13,-10)").style("text-anchor","end"),e.select(".y.axis").transition().call(o.yAxis);var l=e.select(".bars").selectAll("g.item").data(a);l.enter().append("g").append("rect").attr("width","0").attr("height","0"),l.classed("item",!0).attr("transform",function(e,t){return"translate(0,"+o.yScale(t)+")"}),l.selectAll("g.item text").remove();var s=l.select("rect").on("click",function(e){t.changeFilters("all"===n.partner?{partner:e.partner}:{commodity:e.commodity})}),c=l.append("text").classed("label",!0),d=l.append("text").classed("value",!0);s.transition().attr("x",0).attr("y",o.yScale(1)-o.barHeight-5).style("fill",i).attr("height",o.barHeight).attr("width",function(e){return d3.max([0,o.xScale(+e.value)])}),c.attr("x","3").attr("y",o.yScale(1)-o.barHeight-8).text(function(e){return"all"===n.partner?r.lookup(e.partner,"partnerAreas","text"):r.commodityName(e.commodity)}),d.attr("x",function(e){return o.xScale(+e.value)+3}).attr("y",o.yScale(1)-5).text(function(e){return r.numFormat(e.value,null,1)}),l.exit().remove(),0===l.size()&&e.append("text").text("No data available for this chart.").classed("nodata",!0).classed("label",!0).attr("x",o.innerWidth/2+o.margin.left-75).attr("y",o.innerHeight/2+o.margin.top-75)},resizeSvg:function(e,t){e.attr("width",t),o.innerWidth=e.attr("width")-o.margin.left-o.margin.right,o.xScale.range([0,o.innerWidth]),o.xAxis.scale(o.xScale),e.select(".x.axis").transition().call(o.xAxis);var r=e.selectAll("g.item");r.selectAll("rect").attr("width",function(e){return o.xScale(+e.value)}),r.selectAll("text.value").attr("x",function(e){return o.xScale(+e.value)+3})}};return o}),define("helpers/charts/topExportCommodities",["../data","../rowchart","../gui","../controls"],function(e,t,r){"use strict";var o=e,a=$("#topExportCommodities"),n=a.children(".chart"),i=a.children(".chartTitle"),l=n.height(),s=n.width(),c=d3.select("#topExportCommodities .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){n.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(c,n.width())}),t.setup(c),a.slideUp(0)},refresh:function(n,l){if(!l.reporter)return void a.slideUp();var s={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2",initiator:"topExportCommodities"},u={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2"},m="";return u.flow=2,!l.reporter||l.commodity&&"TOTAL"!==l.commodity||l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 exports of goods to the world in "+l.year),!l.reporter||l.commodity&&"TOTAL"!==l.commodity||!l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 exports of goods to "+o.lookup(l.partner,"partnerAreas","text")+" in "+l.year,s.partner=+l.partner,u.partner=+l.partner),l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&l.partner?(i.html(""),void a.slideUp()):l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&!l.partner?(i.html(""),void a.slideUp()):(i.html(m),void e.query(s,function(e,n){if(e&&r.showError(e),!e&&n){var l=o.getData(u,d);i.html(m),a.find(".downloadData").on("click",function(e){e.preventDefault(),r.downloadCsv(m,l)}),a.slideDown(400,function(){t.draw(c,l,u,p.colors[0][1])})}}))}};return p}),define("helpers/charts/topExportMarkets",["../data","../rowchart","../gui","../controls"],function(e,t,r){"use strict";var o=e,a=$("#topExportMarkets"),n=a.children(".chart"),i=a.children(".chartTitle"),l=n.height(),s=n.width(),c=d3.select("#topExportMarkets .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){n.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(c,n.width())}),t.setup(c),a.slideUp(0)},refresh:function(n,l){if(!l.reporter)return void a.slideUp();var s={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2",initiator:"topExportMarkets"},u={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2"},m="";return u.flow=2,!l.reporter||l.commodity||l.partner&&0!==+l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 export markets for goods in "+l.year,s.commodity="TOTAL",u.commodity="TOTAL"),l.reporter&&!l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void a.slideUp()):l.reporter&&l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void a.slideUp()):(!l.reporter||!l.commodity||l.partner&&0!==+l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 export markets for "+o.commodityName(l.commodity)+" in "+l.year,s.commodity=l.commodity,u.commodity=l.commodity),void e.query(s,function(e,n){if(e&&r.showError(e),!e&&n){var l=o.getData(u,d);i.html(m),a.find(".downloadData").on("click",function(e){e.preventDefault(),r.downloadCsv(m,l)}),a.slideDown(400,function(){t.draw(c,l,u,p.colors[0][1])})}}))}};return p}),define("helpers/charts/topImportCommodities",["../data","../rowchart","../gui","../controls"],function(e,t,r){"use strict";var o=e,a=$("#topImportCommodities"),n=a.children(".chart"),i=a.children(".chartTitle"),l=n.height(),s=n.width(),c=d3.select("#topImportCommodities .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){n.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(c,n.width())}),t.setup(c),a.slideUp(0)},refresh:function(n,l){if(!l.reporter)return void a.slideUp();var s={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2",initiator:"topImportCommodities"},u={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2"},m="";return u.flow=1,!l.reporter||l.commodity&&"TOTAL"!==l.commodity||l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 imports of goods from the world in "+l.year),!l.reporter||l.commodity&&"TOTAL"!==l.commodity||!l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 imports of goods from "+o.lookup(l.partner,"partnerAreas","text")+" in "+l.year,s.partner=+l.partner,u.partner=+l.partner),l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&l.partner?(i.html(""),void a.slideUp()):l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&!l.partner?(i.html(""),void a.slideUp()):void e.query(s,function(e,n){if(e&&r.showError(e),!e&&n){var l=o.getData(u,d);i.html(m),a.find(".downloadData").on("click",function(e){e.preventDefault(),r.downloadCsv(m,l)}),a.slideDown(400,function(){t.draw(c,l,u,p.colors[0][0])})}})}};return p}),define("helpers/charts/topImportMarkets",["../data","../rowchart","../gui","../controls"],function(e,t,r){"use strict";var o=e,a=$("#topImportMarkets"),n=a.children(".chart"),i=a.children(".chartTitle"),l=n.height(),s=n.width(),c=d3.select("#topImportMarkets .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){n.on("refreshFilters",this.refresh),$(window).on("resize",function(){t.resizeSvg(c,n.width())}),t.setup(c),a.slideUp(0)},refresh:function(n,l){if(!l.reporter)return void a.slideUp();var s={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2",initiator:"topImportMarkets"},u={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2"},m="";return u.flow=1,!l.reporter||l.commodity||l.partner&&0!==+l.partner||(s.commodity="TOTAL",u.commodity="TOTAL",m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 import markets for goods in "+l.year),l.reporter&&!l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void a.slideUp()):l.reporter&&l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void a.slideUp()):(!l.reporter||!l.commodity||l.partner&&0!==+l.partner||(s.commodity=l.commodity,u.commodity=l.commodity,m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 import markets for "+o.commodityName(l.commodity)+" in "+l.year),void e.query(s,function(e,n){if(e&&r.showError(e),!e&&n){var l=o.getData(u,d);i.html(m),a.find(".downloadData").on("click",function(e){e.preventDefault(),r.downloadCsv(m,l)}),a.slideDown(400,function(){t.draw(c,l,u,p.colors[0][0])})}}))}};return p}),define("helpers/charts",["./charts/choropleth","./charts/yearChart","./charts/infoBox","./charts/topExportCommodities","./charts/topExportMarkets","./charts/topImportCommodities","./charts/topImportMarkets"],function(e,t,r,o,a,n,i){"use strict";var l={balanceColors:["rgb(8,104,172)","rgb(120,198,121)"],importColors:["rgb(240,249,232)","rgb(186,228,188)","rgb(123,204,196)","rgb(67,162,202)","rgb(8,104,172)"],exportColors:["rgb(255,255,204)","rgb(194,230,153)","rgb(120,198,121)","rgb(49,163,84)","rgb(0,104,55)"],setup:function(s){l.colors=[l.balanceColors,l.importColors,l.exportColors],e.colors=l.colors,t.colors=l.colors,o.colors=l.colors,a.colors=l.colors,n.colors=l.colors,i.colors=l.colors,t.setup(),r.setup(),o.setup(),a.setup(),n.setup(),i.setup(),e.setup(function(){var e=l._getCssForSVGs();l._injectCSSintoSVG(e,d3.selectAll("svg")),s()})},_getCssForSVGs:function(){for(var e="",t=0;t<document.styleSheets.length;t++)if(document.styleSheets[t].href&&document.styleSheets[t].href.indexOf("main.svg.css")>=0)for(var r=0;r<document.styleSheets[t].cssRules.length;r++)e+=document.styleSheets[t].cssRules[r].cssText+" ";return e},_injectCSSintoSVG:function(e,t){t.insert("defs",":first-child").append("style").attr("type","text/css").text(e)}};return l}),define("helpers/embed",["require"],function(e){"use strict";var t={balanceColors:["rgb(8,104,172)","rgb(120,198,121)"],importColors:["rgb(240,249,232)","rgb(186,228,188)","rgb(123,204,196)","rgb(67,162,202)","rgb(8,104,172)"],exportColors:["rgb(255,255,204)","rgb(194,230,153)","rgb(120,198,121)","rgb(49,163,84)","rgb(0,104,55)"],setup:function(r){DEBUG&&console.log("This is an embed of "+r.embed),$("body").addClass("embed").addClass(r.embed+"Embedded"),$("#embedCredit").show(),$("#embedCredit a").attr("href",window.location.href.split("&embed")[0]),e(["./charts/"+r.embed],function(e){e.colors=[t.balanceColors,t.importColors,t.exportColors],e.setup(),e.refresh(null,r)})},hide:function(e){e.forEach(function(e){$("#"+e).hide()}),$("#loadingDiv").hide()}};return t}),define("helpers/intro",["require"],function(){"use strict";var e=[{intro:'<h3>Welcome to the International Trade in Goods visualization.</h3><p style="font-size: 14px">This tool allows you to explore official trade in goods data using live data from the UN COMTRADE database.</p><p style="font-size: 14px">The tool was developed by the Department for Business Innovation and Skills (UK).</p>'},{element:document.querySelector("#controls"),intro:"The controls at the top of the page allow you to filter the data so you can focus on specific information and find what matters to you most.",position:"bottom-middle-aligned"},{element:document.querySelector("#selectReporterContainer"),intro:"Selecting a reporter is your starting point. You will need to select this to be able to select a partner, commodity and year.",position:"right"},{element:document.querySelector("#selectPartnerContainer"),intro:"Selecting a partner will allow you to see details of trade flows between your selected reporter and partner. These details will show in the Key Facts box and on the graphs below the map.",position:"bottom-middle-aligned"},{element:document.querySelector("#selectCommodityContainer"),intro:"Selecting the commodity box will display a list of classification of goods. This allows you to drill down the trade data to a greater level of detail. Selecting a commodity will update the map and the graphs below.",position:"left"},{element:document.querySelector("#flowButtons"),intro:"The map and legend will update based on whether you select ‘exports’, ‘imports’ or ‘balance’.",position:"right"},{element:document.querySelector("#choroplethTitle .chartTitle"),intro:"The map visualization shows at a glance the top trading partners for the selected reporter country, and commodity if selected. You can hover over an area on the map to get quick insights into that area, or select the area as a reporter or partner.",position:"bottom-middle-aligned"},{element:document.querySelector("#infoBox"),intro:"The Key Facts box gives a breakdown of trade between your selected reporter and partner, such as export, import, balance and bilateral trade figures.",position:"right"},{element:document.querySelector("#yearChart .chartTitle"),intro:"Below the map, you will find charts showing further detail based on your filter selection. Please note that these will be displayed or hidden based on your selections. You can download these charts by selecting the arrows to the left of the charts.",position:"top"},{element:document.querySelector("#feedback-tab"),intro:"When you're done we'd really appreciate your thoughts on the visualization.",position:"left"},{intro:"Now try it yourself!"}],t={setup:function(t){var r=introJs(),o=document.cookie.replace(/(?:(?:^|.*;\s*)introDone\s*\=\s*([^;]*).*$)|^.*$/,"$1"),a=function(e){var t=e.keyCode||e.which;(["wheel","mousewheel","DOMMouseScroll"].indexOf(e.type)>-1||[32,33,34,35,36,38,40].indexOf(t)>-1)&&e.preventDefault()},n=function(){$(window).on("mousewheel.trademap DOMMouseScroll.trademap keydown.trademap",a)},i=function(){$(window).off("mousewheel.trademap DOMMouseScroll.trademap keydown.trademap")},l=function(e){var t=Math.max(0,$(e).offset().top-$(window).height()/2);"feedback-tab"===e.id&&(t=0),"infoBox"===e.id&&(t=0,$("#infoBox").css("top",$(window).height()-$("#infoBox").height()-10+"px")),$("html, body").animate({scrollTop:t},500)},s=function(){document.cookie="introDone=true; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/"},c=function(){$("html, body").animate({scrollTop:0},500),n(),r.start()},d=function(e){0===e.queryCount&&(c(),window.removeEventListener("queryQueueUpdate",d,!1))},p=function(){i(),s()};r.setOptions({skipLabel:'<span class="glyphicon glyphicon-remove"></span>',doneLabel:'<span class="glyphicon glyphicon-remove"></span>',nextLabel:'<span class="glyphicon glyphicon-arrow-right"></span>',prevLabel:'<span class="glyphicon glyphicon-arrow-left"></span>',showBullets:!1,showStepNumbers:!1,scrollToElement:!1,steps:e}),r.oncomplete(p),r.onexit(p),r.onbeforechange(l),$("#startIntro").click(function(e){e.preventDefault(),c()}),(!o||"true"===t.intro)&&$(window).width()>800&&window.addEventListener("queryQueueUpdate",d,!1)}};return t}),require.config({urlArgs:"build="+(new Date).getTime()}),require(["helpers/data","helpers/gui","helpers/controls","helpers/charts","helpers/embed","helpers/intro"],function(e,t,r,o,a,n){"use strict";"undefined"==typeof DEBUG&&(window.DEBUG=0),$(document).ready(function(){return Modernizr.svg?(Modernizr.cors||($("#userAlert").removeClass("hidden"),$("#userAlert .message").html('<strong>Warning</strong>: This application may not work correctly. Your browser does not support querying APIs which is necessary for this application to work. (Missing <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>).<br /> Please try using a recent version of Firefox or Chrome.'),$("#loadingDiv").hide()),void e.setup(function(e){if(e)return DEBUG&&console.log(e),$("#userAlert").removeClass("hidden"),void $("#userAlert .message").html("Error: Failed to load required files for startup.");var i=r.decodeURL(),l=["choropleth","yearChart","topImportCommodities","topExportCommodities","topImportMarkets","topExportMarkets"];return i.embed&&l.indexOf(i.embed)>-1?(l.splice(l.indexOf(i.embed),1),a.hide(l),void a.setup(i)):(t.setup(),n.setup(i),r.setup(),void o.setup(function(){r.initializeFilters()}))})):($("#userAlert").removeClass("hidden"),$("#userAlert .message").html("Error: it looks like your browser does not support SVG which is required for this visualization. Please consider updating to a more recent browser."),void $("#loadingDiv").hide())})}),define("main",function(){}),require(["main"]);